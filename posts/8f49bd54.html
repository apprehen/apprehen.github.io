<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>前端技术探索 | 月晕</title><meta name="keywords" content="React,前端框架,前端"><meta name="author" content="月晕"><meta name="copyright" content="月晕"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="前端技术探索"><meta name="application-name" content="前端技术探索"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="前端技术探索"><meta property="og:url" content="https://blog.yueyun.site/posts/8f49bd54.html"><meta property="og:site_name" content="月晕"><meta property="og:description" content="本文主要介绍前端技术探索，包括React、JavaScript、TypeScript等。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg"><meta property="article:author" content="月晕"><meta property="article:tag" content="JS,前端,前端开发,TS,TypeScript,Node,Node.js,Nodejs,Node,后端"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg"><meta name="description" content="本文主要介绍前端技术探索，包括React、JavaScript、TypeScript等。"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.yueyun.site/posts/8f49bd54"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><meta name="google-site-verification" content="QmqYgcPLCjEZmEbdJVKduTaxnvd3OFJRyp3BLB2f0VQ"><meta name="baidu-site-verification" content="codeva-XPqAkKFOID"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script async src="https://www.googletagmanager.com/gtag/js?id=G-W3DLGJMJDY"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-W3DLGJMJDY")</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"T^T","backTitle":"Ciallo~"},
  LA51: {"enable":true,"ck":"3GbfdCFGvNdWoQg1","LingQueMonitorID":"3GbfdCFGvNdWoQg1"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://chat.yueyun.site',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🖥️ JavaScript爱好者","🔍 前沿技术追随者","🩵 吃饭睡觉看动漫","🔨 前端后端一把梭","🤓 玉玉郁郁第一名","🧟 间歇性发奋图强","😵 持续性混吃等死","🥰 欢迎找我来聊天"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 月晕","link":"链接: ","source":"来源: 月晕","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"月晕",title:"前端技术探索",postAI:"",pageFillDescription:"网络库的封装和实现, 背景, 方案和设计, 库结构的宏观设计, 请求缓存, 请求结果怎么存? 存在那些地方? 缓存键是什么?, 缓存何时失效? 基于时间还是其他条件?, 如何实现?, 请求幂等, 样本代码, 大文件上传, 背景, 问题和方案, 如何减少页面阻塞, 前后端如何协调, 创建文件协议, hash 校验协议, 分片数据上传协议, 分片合并协议, 代码如何组织, upload-core 中的通用函数, 前端(upload-client)代码中的复杂问题, 如何对文件分片, 如何控制请求, 后端代码中的复杂问题, 如何隔离不同的文件上传?, 如何保证分片不重复?, 合并分片到底做什么?, 实际访问文件, ABT 在前端基建中的实践, 背景, 问题和方案, 如何协作？, 前端如何开发？, 流程和结构, 如何分流？, 如何改变运行代码？, 实验推全后如何处理？, 细节问题？网络库的封装和实现背景背景虽然在前端领域有很多成熟的请求库但是在实际的开发过程中很难符合契合实际的开发需求比如经典的库并不具备以下功能请求重试请求缓存请求幂等请求串行请求并发虽然提供的三方功能很多仍然存在与上层框架过度绑定导致开发场景受限无法提供统一的成熟度不很完全不能自己随时开口子改设计没有聚合基础的请求库依然需要手动整合公共库并不包含内部制定的协议规范即便使用公共库也需要进行二次封装需要自行封装一套适配公司业务的前端请求库方案和设计库结构的宏观设计整个库结构包含三层从下往上依次是请求实现层提供请求基本功能提供网络上层控制比如请求串行请求并行请求重试请求防重等功能为请求绑定业务功能该层是接入公司内部协议规范和接口文档向外提供业务接口层是对代码逻辑的划分具体实现有很多种每一层是一个包可以使用多包管理每个层是一个项目子文件夹优化设计在请求实现层的实现有多种方式基于原生基于原生这种实现的多样性可能导致这一层的不稳定而是基础层这样会导致向上传递不稳定性为了隔离这种情况我们使用依赖倒置原则彻底将和请求的实现解耦比如下面的示意代码定义接口并不实现本模块的大部分功能都需要使用到创建一个可以重试的请求进一步配置创建一个并发请求进一步配置代码示意使用实现其他方法代码示意这样一来如果实现改变时无须对做改动仅需新增实现并改动依赖即可比如将来如果改为使用来完成请求仅需要做一下改动新增库使用实现其他方法请求缓存请求缓存是指创建一个带有缓存的请求当没有命中缓存时发送请求并缓存结果当有缓存时直接返回缓存请求使用缓存请求使用缓存要实现此功能需要考虑几个核心的问题请求结果怎么存存在那些地方缓存键是什么我们希望用户能够指定缓存方案内存持久化同时也能够指定缓存键为某次请求的配置使用作为缓存键是否开启持久化缓存存储有多种方案不同的方案能够存储的格式不同支持的功能不同使用的不同兼容性不同为了去除这种差异避免将来存储方案变动时对其他代码造成影响需要设计一个稳定的借口来抹除不同方案的差异其他字段缓存何时失效基于时间还是其他条件我们希望用户能够指定缓存如何失效指定缓存时间自定义缓存是否有效提供配置后配置失效表示缓存键表示此次请求配置返回表示缓存有效如何实现核心逻辑参数归一化使用缓存仓库获得请求实例对请求进行配置对请求进行配置注册请求发送前的事件获得缓存键是否存在缓存返回缓存结果获得缓存键请求幂等幂等性是一个数字概念常见于抽象代数无论的值是多少不变为在网络请求中很多接口都要求幂等性比如支付同一订单多次支付和一次支付对用户余额的影响应该是一样的要解决这个问题就必须保证要求幂等的请求不能重复提交这里的关键问题就是定义什么是重复我们可以把重复定义为请求方法请求头请求体完全一致因此我们可以使用将它们编码成一个字符串当请求幂等时直接返回缓存结果即可在实现上可以直接利用缓存功能实现样本代码公司接口数量庞大并且时常变化如果层是全部人工处理不仅耗时而且容易出错可以通过一些标准化的工具让整个过程自动化样版代码的生成使用开发了命令行工具用于样本代码的生成接口平台提供了生成标准格式的通过请求即可生成标准的描述文件发布文章其他字段获取文章其他字段生成的样版代码发布文章获取文章大文件上传背景平台中包含企业资料会议视频等大文件的上传如果不做特殊处理将遇到以下的问题网络中断程序异常退出等问题导致文件上传失败而不得不重新上传同一文件被不同用户反复上传白白占用网络和服务器储存资源问题和方案大文件上传的普遍方案是文件分片上传如果把文件上传看做是一个不可分割的事务那么分片的目标就是把一个耗时的大事务划分为一个一个的小事务由于使用层来承接前端的文件请求因此需要开通前后端所有跟文件上传的阻碍分片上传的主要障碍集中在如何减少页面阻塞前后端如何协调代码如何组织前端代码中的复杂逻辑代码中的复杂逻辑如何减少页面阻塞分片上传的一个首要目标就是要尽量避免相同的分片重复上传服务器必须要能够识别来自各个客户端的各个上传请求中是否存在与过去分片相同的上传请求服务器如何识别那些分片是相同的呢首先需要对相同下一个定义文件内容一样即为相同可以对文件内容进行二进制的对比是一个非常耗时的操作于是可以可以选择基于内容的表示对比是一种算法可以将任何长度的数据转化成定长的数据不仅针对分片如此针对整个文件也是如此可见客户端需要承担两件重要的事情对文件进行分片并计算每个分片的值根据所有的值计算整个文件的值而计算是一件密集型的操作如果不加处理将会导致长时间的阻塞主线程一般的做法为了解决这个问题可以对大文件上传做一个假设绝大部分的文件上传都是新文件上传有了这个假设我们就无须等待整体的计算结果直接上传分片即可同时可以把分片操作使用多线程异步的方式进行上传处理这样做的好处是页面完全无阻塞也无须等待整体即可启动上传相比于传统方案对于新文件上传可以缩短整体上传时间消除页面的阻塞对于旧文件上传可能会产生一些无效的请求但这些请求仅传递的是并不真实上传文件数据所以对网络和服务器影响很小加上旧文件上传情况相对较少所以整体可以忽略不计前后端如何协调文件上传涉及到前后端的交互需要建立一个标准的通信协议通过协议要能完成下面几件核心交互创建文件校验分片数据上传分片合并创建文件协议当客户端发送分片到服务器需要告知服务器分片属于那一次文件上传因此需要一个唯一标识来标识某一次文件上传创建文件协议就是用于获取文件上传的唯一标识文件上传的唯一标识分片大小单位字节校验协议客户端有时需要校验单个分片或整个文件的服务器需要告知客户端它们目的的具体情况取值或分别代表分片和文件整体分片或文件的具体值指示服务器是否已经存储了对应的分片或文件当校验文件时持有的响应字段指示该文件还剩余那些没有上传当校验文件时持有响应字段如果该文件已经完成上传出现字段表示文件而请求地址分片数据上传协议通过此协议上传具体的文件分片数据分片合并协议当所有的分片全部上传后通过此协议请求服务器完成分片合并代码如何组织大文件上传的搭建分为三层上传协议约定前后端的通信格式基于协议的提供协议字段的创建读取前后端通用工具函数等核心功能应用于客户端的用于的中的通用函数统一前后端涉及到的基于各种事件的处理使用发布订阅模式提供统一的类前端可能出现的各种事件上传进度改变事件上传暂停恢复事件等等后端可能出现的各种事件分片写入完成事件分布合并完成事件等等为了支撑前后端的多任务并发执行提供类前端可能的并发执行并发请求后端可能的并发执行并发的分片校验可并发执行的任务队列待执行的任务当前正在执行的任务数任务状态最大并发数添加任务添加任务并执行启动启动任务当前无任务触发事件设置任务状态为触发事件开始执行下一个任务执行下一个任务如果整体的任务状态不是结束并发已满结束取出第一个任务没有任务了暂停执行执行任务任务执行完成后当前任务数执行下一个任务暂停前端代码中的复杂问题前端涉及到两个核心问题如何对文件分片如何控制请求如何对文件分片首先要实现分片对象的处理分片的二进制数据分片的起始位置分片的结束位置分片的值分片在文件的索引创建一个不带的计算的值接下来要对整个文件进行分片分片的方式有很多如普通分片基于多线程的分片基于主线程时间切片的分片其他分片模式考虑到通用性必须要向上层提供不同的分片模式同时还要允许上层自定义分片模式因此在设计上使用基于抽象类的模板模式来完成处理分片大小单位字节待分片的文件整个文件的分片列表已计算的分片数据计算的工具是否已经分片获取分片数组计算完成分片完成后一些需要销毁的工作基于此抽象类即可实现多种形式的分片模式每种模式只需要继承实现计算分片的即可比如基于多线程的分片类可以非常简单的实现如何控制请求对请求的控制涉及多个方面的问题如何充分利用带宽分片上传中涉及到大量的请求发送这些请求即不能一起发送造成网络阻塞也不能依次发送浪费带宽资源因此需要有请求并发控制的机制方案利用基础库的实现并发控制如何与上层请求库解耦考虑到通用性上层应用可能会使用各种请求库发送请求因此前端不能绑定任何的请求库方案使用策略模式对请求库解耦比如请求策略请求策略文件创建请求返回分片上传请求文件合并请求返回文件校验请求请求控制请求策略没有传递则使用默认策略分片策略没有传递则默认多线程分片任务队列其他属性略初始化获取文件分片事件监听分片事件处理分片上传任务加入队列校验文件已存在分片上传整体事件处理校验文件已存在根据重新编排后续任务后端代码中的复杂问题相对于客户端而言服务器面临着更大的挑战如何隔离不同的文件上传在创建文件协议中服务器使用生成一个不可纂改的唯一编码用于标识不同的文件上传如何保证分片不重复重复的含义是指不保存重复分片不上传重复分片这就要求分片跨文件唯一并且永不删除也就是服务器并不保存合并之后的文件仅记录文件中的分片顺序合并分片到底做什么合并会造成很多问题比如极其耗时需要找到文件并组装数据冗余所以服务器并不发生真正的合并而是在数据库中记录文件中包含的分片因此合并操作时服务器仅做简单的处理校验文件大小校验文件标记文件状态生成文件访问地址上面操作效率很高实际访问文件由于服务器并未发生真正的文件合并当后续请求该文件时服务器需要动态处理具体的做法是服务器收到对文件的请求并在数据库中找到了对应的文件服务器读取文件的所有分片依次找到对应的分片文件服务器利用的并发控制能力逐步产生文件读取流并利用管道直接输出到网络在前端基建中的实践背景产品有时无法确定哪种设计方案更好因此希望前端能够同时上线多个产品方案根据某套规则将用户导流到不同的方案在用户体验理论研究中这种做法称之为后续简称一次实验会生成至少两套方案对照组实验组并且可以允许多个实验共存实验会涉及多个岗位的协调包含前端后端测试运维产品其中起主要作用的是产品和前端问题和方案为前端带来诸多的挑战其中包括如何协作在一个实验生命周期内涉及到哪些角色角色之间是如何协作的前端如何开发实验具有以下几个特点多个实验共存产品可能会先后发起几十个甚至上百个实验不同的实验有不同的分流规则每个实验又有多个对照组实验是精确到组件的一个实验对应到多个前端组件一个组件不同的对照组之间的差异是灵活的实验是频繁的用户参与实验必须是无感的实验推全后只保留一个对照组流程和结构运作流程的结构整个包含了诸多和工具为应用开发提供支撑其中提供最底层的核心功能比如实验信息分流控制代码剪枝数据决策等等针对服务器提供一些中间件针对前端两种框架提供一些组件仓库路由等针对前端两种常见构建工具提供一些插件集成比如工具插件命令行工具等等如何分流使用存储当前每个实验不同对照组的参与人数使用浏览器指纹用户身份保证同一用户对同一实验仅参与一个组两种做法将指纹用户身份组打包成发送给客户端不精准成本低使用数据库保存映射关系精准成本高按照规则中的分流比例为新用户分配组别将所有实验的以及每个组别的编号下发到客户端如何改变运行代码实验和组别对运行时的影响主要是渲染组件的不同但也有可能对其他代码造成影响由于每次实验所产生的差异是极其灵活的因此难以使用一种标准化的静态格式来描述差异这就不可避免的造成了对业务代码的侵入基建的一个重要目标就是要将这种侵入最小化标准化提供高阶组件屏蔽组件差异示例示例提供高阶函数屏蔽差异使用自定义指令屏蔽差异利用自定义的插件会将上面的代码转换为与此同时我们也改变了默认情况下开启后上面的代码会被转换为下面的我们对此作了改变将代码变成了实验推全后如何处理当产品完成实验后会选定一种方案进行推全此时会涉及到对应实验的代码如何剪枝的问题由于实验并不向外界暴露当前用户所处的实验分组因此业务开发者要根据不同分组进行不同处理的代码逻辑必须使用实验才能完成这就对自动化的实验推全提供了基础由于所有的实验代码都是使用完成的因此可以通过一个简洁的逻辑即可完成自动化实验推全实验为各种构建工具提供插件打包时插件会通过代码分析找出当前哪些文件对应到哪些实验插件会对照最新的实验信息找到已经被推全的实验插件定位到所有与该实验有关的源码文件插件提示开发者是否对已推全的实验进行剪枝开发者确认后插件自动修改完成剪枝通过完成剪枝逻辑是非常容易的比如针对组件的剪枝剪枝前剪枝后假设将推全细节问题白屏问题对于一个应用它的组件渲染取决于所处的组别而它所属哪个组别又必须通过网络通信才能确定这就导致了首屏渲染的白屏问题而我们观察到整个应用中实际上只有部分组件会参与到实验对于没有参与到实验的组件是不需要等待分组信息的因此我们将参与到实验的组件制作为异步组件从而可以不影响其他组件的渲染代码检查问题由于实验推全时需要对代码进行剪枝剪枝发生在编译时态它通过检查代码中包含的代码完成而大部分中的都需要绑定实验名称例如如果实验名称来自于一个变量或表达式或者其他需要在运行时才能确定的值这就会导致剪枝失败因此我们制作了插件来约束开发者必须使用字面量或者其他在编译时态能确定的值开发规范不会暴露用户的分组信息给开发者这主要是考虑到开发者可能写出下面的代码用户的分组代码用户的分组代码这样的代码无法被代码剪枝工具察觉容易在实验推全后仍然保留在代码中虽然功能性不受影响但会逐步降低代码的可维护性以上是不暴露的主要原因但开发者仍然有可能间接的获取到用户的分组比如代码代码这种代码很难通过自动化工具检查处理因此需要通过开发规范来约束所有跟实验相关的处理必须通过完成",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-08-29 07:16:27",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W3DLGJMJDY"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-W3DLGJMJDY")</script><meta name="generator" content="Hexo 7.0.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/yueyun.jpg"><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">月晕</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>留言</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/resume/"><i class="anzhiyufont anzhiyu-icon-book faa-tada" style="font-size:.9em"></i><span> 简历</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div class="nav-change" id="nav-darkmode"><a class="darkmode_switchbutton" title="显示模式切换" onclick="darkmo" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><input id="center-console" type="checkbox"><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url">前端</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/JavaScript/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>JavaScript</span></a><a class="article-meta__tags" href="/tags/React/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>React</span></a><a class="article-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>前端</span></a><a class="article-meta__tags" href="/tags/TypeScript/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>TypeScript</span></a></span></div></div><h1 class="post-title" itemprop="name headline">前端技术探索</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="post-meta-icon anzhiyufont anzhiyu-icon-calendar-days"></i><span class="post-meta-label">发表于</span><time itemprop="dateCreated datePublished" datetime="2024-06-23T13:26:24.000Z" title="发表于 2024-06-23 13:26:24">2024-06-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">7.5k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为杭州"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>杭州</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/8f49bd54.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.yueyun.site/posts/8f49bd54.html"><header><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url">前端</a><a href="/tags/JavaScript/" tabindex="-1" itemprop="url">JavaScript</a><a href="/tags/React/" tabindex="-1" itemprop="url">React</a><a href="/tags/%E5%89%8D%E7%AB%AF/" tabindex="-1" itemprop="url">前端</a><a href="/tags/TypeScript/" tabindex="-1" itemprop="url">TypeScript</a><h1 id="CrawlerTitle" itemprop="name headline">前端技术探索</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">月晕</span><time itemprop="dateCreated datePublished" datetime="2024-06-23T13:26:24.000Z" title="undefined 2024-06-23 13:26:24">2024-06-23</time></header><h1 id="网络库的封装和实现"><a href="#网络库的封装和实现" class="headerlink" title="网络库的封装和实现"></a>网络库的封装和实现</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote><p>背景: 虽然在前端领域有很多成熟的请求库, 但是在实际的开发过程中, 很难符合契合实际的开发需求</p></blockquote><p>比如经典的库: <strong>axios</strong> 并不具备以下功能</p><ul><li>请求重试</li><li>请求缓存</li><li>请求幂等</li><li>请求串行</li><li>请求并发</li><li>…</li></ul><p><strong>SWR &#x2F; VueRequest</strong> 虽然提供的三方功能很多, 仍然存在</p><ul><li>与上层框架过度绑定导致开发场景受限, 无法提供统一的 API</li><li>成熟度不很完全(?) 不能自己随时开口子改设计</li><li>没有聚合基础的请求库, 依然需要手动整合</li><li>公共库并不包含内部制定的协议规范, 即便使用公共库,也需要进行二次封装</li></ul><p><strong>需要自行封装一套适配公司业务的前端请求库</strong></p><h2 id="方案和设计"><a href="#方案和设计" class="headerlink" title="方案和设计"></a>方案和设计</h2><h3 id="库结构的宏观设计"><a href="#库结构的宏观设计" class="headerlink" title="库结构的宏观设计"></a>库结构的宏观设计</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/1.png"></p><p>整个库结构包含三层, 从下往上依次是:</p><ul><li>请求实现层: 提供请求基本功能</li><li>request-core: 提供网络上层控制, 比如请求串行, 请求并行, 请求重试, 请求防重等功能</li><li>request-bus: 为请求绑定业务功能, 该层是接入公司内部协议规范和接口文档, 向外提供业务接口 API</li></ul><blockquote><p>层是对代码逻辑的划分,具体实现有很多种</p><ul><li>每一层是一个包, 可以使用多包管理(momorepo)</li><li>每个层是一个项目子文件夹</li><li>…..</li></ul></blockquote><p><strong>优化设计</strong></p><p>在请求实现层的实现有多种方式</p><ul><li>基于 XHR 原生 || 基于 fetch 原生</li></ul><p>这种实现的多样性可能导致这一层的不稳定, 而 request-imp 是基础层, 这样会导致向上传递不稳定性,为了隔离这种情况<br>我们使用 DIP(Dependence Inversion Principle 依赖倒置原则) 彻底将 request-core 和请求的实现解耦</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/2.png"></p><p>比如下面的示意代码</p><p>request-core</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义接口 并不实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Requestor</span> &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">RequestOptions</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Response</span>&gt;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 本模块的大部分功能都需要使用到Requestor</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">req</span>: <span class="title class_">Requestor</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params">requestor: Requestor</span>) &#123;</span><br><span class="line">  req = requestor</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useRequestor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个可以重试的请求</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRetryRequestor</span>(<span class="params">maxCount = <span class="number">5</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> req = <span class="title function_">useRequestor</span>()</span><br><span class="line">  <span class="comment">// 进一步配置</span></span><br><span class="line">  <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个并发请求</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createParallelRequestor</span>(<span class="params">maxCount = <span class="number">5</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> req = <span class="title function_">useRequestor</span>()</span><br><span class="line">  <span class="comment">// 进一步配置</span></span><br><span class="line">  <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>request-axios-imp 代码示意</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Requestor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ins = axios.<span class="title function_">create</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="attr">requestor</span>:<span class="title class_">Requestor</span> = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url,options</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用axios实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>request-bus 代码示意</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; requestor &#125; <span class="keyword">from</span> <span class="string">&#x27;request-axios-imp&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; inject &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"><span class="title function_">inject</span>(requestor)</span><br></pre></td></tr></table></figure><p>这样一来, 如果实现改变时, 无须对 reques-core 做改动, 仅需新增实现并改动依赖即可</p><p>比如, 将来如果改为使用 fetch api 来完成请求, 仅需要做一下改动</p><p>新增库 request-fetch-imp</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Requestor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ins = axios.<span class="title function_">create</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="attr">requestor</span>:<span class="title class_">Requestor</span> = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url,options</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用fetch实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h3><p>请求缓存是指创建一个带有缓存的请求, 当没有命中缓存时发送请求并缓存结果,当有缓存时直接返回缓存</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> req = <span class="title function_">createCacheRequest</span>()</span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/a&#x27;</span>) <span class="comment">// 请求</span></span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/a&#x27;</span>) <span class="comment">// 使用缓存</span></span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/b&#x27;</span>) <span class="comment">// 请求</span></span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/b&#x27;</span>) <span class="comment">// 使用缓存</span></span><br></pre></td></tr></table></figure><p>要实现此功能需要考虑几个核心的问题</p><h4 id="请求结果怎么存-存在那些地方-缓存键是什么"><a href="#请求结果怎么存-存在那些地方-缓存键是什么" class="headerlink" title="请求结果怎么存? 存在那些地方? 缓存键是什么?"></a><strong>请求结果怎么存? 存在那些地方? 缓存键是什么?</strong></h4><p>我们希望用户能够指定缓存方案(内存&#x2F;持久化), 同时也能够指定缓存键</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> req = <span class="title function_">createCacheRequestor</span>(&#123;</span><br><span class="line">    <span class="attr">key</span>: (config) &#123;</span><br><span class="line">    	<span class="comment">// config 为某次请求的配置</span></span><br><span class="line">    	<span class="keyword">return</span> config.<span class="property">pathname</span> <span class="comment">// 使用pathname作为缓存键</span></span><br><span class="line">	&#125;,</span><br><span class="line">    <span class="attr">persist</span>: <span class="literal">true</span> <span class="comment">// 是否开启持久化缓存</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>存储有多种方案, 不同的方案能够存储的格式不同, 支持的功能不同, 使用的 API 不同, 兼容性不同</p><p>为了去除这种差异, 避免将来存储方案变动时对其他代码造成影响, 需要设计一个稳定的借口来抹除不同方案的差异<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/3.png"></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CacheStore</span> &#123;</span><br><span class="line">  <span class="title function_">has</span>(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line">  set&lt;T&gt;(<span class="attr">key</span>: <span class="built_in">string</span>, ...<span class="attr">values</span>: T[]): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;</span><br><span class="line">  get&lt;T&gt;(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;T&gt;</span><br><span class="line">  <span class="comment">// 其他字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useCacheStore</span>(<span class="params">isPersist</span>): <span class="title class_">CacheStore</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isPersist) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createMemoryStore</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createStorage</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="缓存何时失效-基于时间还是其他条件"><a href="#缓存何时失效-基于时间还是其他条件" class="headerlink" title="缓存何时失效? 基于时间还是其他条件?"></a>缓存何时失效? 基于时间还是其他条件?</h4><p>我们希望用户能够指定缓存如何失效</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> req = <span class="title function_">createCacheRequestor</span>(&#123;</span><br><span class="line">    <span class="attr">duration</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> <span class="comment">//指定缓存时间</span></span><br><span class="line">    isValid (key, config)&#123;</span><br><span class="line">    	<span class="comment">// 自定义缓存是否有效,提供配置后,duration配置失效</span></span><br><span class="line">    	<span class="comment">// key表示缓存键, config表示此次请求配置</span></span><br><span class="line">    	<span class="comment">// 返回true表示缓存有效</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现?"></a><strong>如何实现?</strong></h4><p>核心逻辑</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCacheRequestor</span>(<span class="params">cacheOptions</span>) &#123;</span><br><span class="line">  <span class="comment">// 参数归一化</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="title function_">normalizeOptions</span>(cacheOptions)</span><br><span class="line">  <span class="comment">// 使用缓存仓库</span></span><br><span class="line">  <span class="keyword">const</span> store = <span class="title function_">useCacheSotre</span>(options.<span class="property">persist</span>)</span><br><span class="line">  <span class="comment">// 获得请求实例</span></span><br><span class="line">  <span class="keyword">const</span> req = <span class="title function_">useRequestor</span>()</span><br><span class="line">  <span class="comment">// 对请求进行配置</span></span><br><span class="line">  <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对请求进行配置</span></span><br><span class="line"><span class="comment">// 注册请求发送前的事件</span></span><br><span class="line">req.<span class="title function_">on</span>(<span class="string">&#x27;beforeRequest&#x27;</span>, <span class="keyword">async</span> (config) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> key = option.<span class="title function_">key</span>(config) <span class="comment">// 获得缓存键</span></span><br><span class="line">  <span class="keyword">const</span> hashKey = <span class="keyword">await</span> store.<span class="title function_">has</span>(key) <span class="comment">// 是否存在缓存</span></span><br><span class="line">  <span class="keyword">if</span> (hashKey &amp;&amp; option.<span class="title function_">isValid</span>(key, config)) &#123;</span><br><span class="line">    <span class="comment">// 返回缓存结果</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">req.<span class="title function_">on</span>(<span class="string">&#x27;responseBody&#x27;</span>, <span class="function">(<span class="params">config, resp</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> key = options.<span class="title function_">key</span>(config) <span class="comment">// 获得缓存键</span></span><br><span class="line">  store.<span class="title function_">set</span>(key, resp.<span class="title function_">toPlain</span>())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="请求幂等"><a href="#请求幂等" class="headerlink" title="请求幂等"></a>请求幂等</h3><p>幂等性是一个数字概念, 常见于抽象代数 f(n) &#x3D; 1 ^ n 无论 n 的值是多少, f(n)不变为 1<br>在网络请求中, 很多接口都要求幂等性, 比如支付, 同一订单多次支付和一次支付对用户余额的影响应该是一样的</p><p>要解决这个问题就必须保证: <strong>要求幂等的请求不能重复提交</strong></p><p>这里的关键问题就是定义什么是<strong>重复</strong>?</p><p>我们可以把<strong>重复</strong>定义为: 请求方法, 请求头, 请求体完全一致</p><p>因此我们可以使用<strong>hash</strong>将它们编码成一个字符串</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genKey</span>(<span class="params">req</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>()</span><br><span class="line">  spark.<span class="title function_">append</span>(req.<span class="property">url</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> req.<span class="property">headers</span>) &#123;</span><br><span class="line">    spark.<span class="title function_">append</span>(key)</span><br><span class="line">    spark.<span class="title function_">append</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  spark.<span class="title function_">append</span>(req.<span class="property">body</span>)</span><br><span class="line">  <span class="keyword">return</span> spark.<span class="title function_">end</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当请求幂等时, 直接返回缓存结果即可<br>在实现上, 可以直接利用缓存功能实现</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createIdempotentRequestor</span>(<span class="params">genKey</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createCacheRequestor</span>(&#123;</span><br><span class="line">        <span class="attr">key</span>: <span class="function">(<span class="params">config</span>) =&gt;</span> genKey &gt; <span class="title function_">genKey</span>(config) : <span class="title function_">hashRequest</span>(config),</span><br><span class="line">    	<span class="attr">persist</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="样本代码"><a href="#样本代码" class="headerlink" title="样本代码"></a>样本代码</h3><p>公司 API 接口数量庞大并且时常变化, 如果 request-bus 层是全部人工处理不仅耗时, 而且容易出错, 可以通过一些标准化的工具让整个过程自动化</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/4.png"></p><p><strong>样版代码的生成</strong></p><p>使用 node 开发了命令行工具 <code>request-template-cli</code> 用于样本代码的生成<br>接口平台提供了生成标准格式的 API，通过请求 API 即可生成标准的 JSON 描述文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;article&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;publishArticle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/article&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;发布文章&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;POST&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;idempotent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pager&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="comment">// 其他字段</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;getArticles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/article&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取文章&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;idempotent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pager&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="comment">// 其他字段</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>生成的样版代码</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request-bus/templet/article.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; createIdempotentRequest &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发布文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publishArticle = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> req = <span class="title function_">createIdempotentRequest</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (<span class="attr">article</span>: <span class="title class_">Article</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> req.<span class="title function_">post</span>(<span class="string">&#x27;/api/article&#x27;</span>, article).<span class="title function_">then</span>(<span class="function">(<span class="params">resp</span>) =&gt;</span> resp.<span class="title function_">json</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getArticles = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (<span class="attr">page</span>: <span class="built_in">number</span>, <span class="attr">size</span>: <span class="built_in">number</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line">      .<span class="title function_">get</span>(<span class="string">&#x27;/api/article&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">params</span>: &#123;</span><br><span class="line">          page,</span><br><span class="line">          size</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">resp</span>) =&gt;</span> resp.<span class="title function_">json</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><h1 id="大文件上传"><a href="#大文件上传" class="headerlink" title="大文件上传"></a>大文件上传</h1><h2 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h2><blockquote><p>Saas 平台中包含企业资料, 会议视频等大文件的上传, 如果不做特殊处理将遇到以下的问题</p><ol><li>网络中断, 程序异常退出等问题导致文件上传失败, 而不得不重新上传</li><li>同一文件被不同用户反复上传, 白白占用网络和服务器储存资源</li></ol></blockquote><h2 id="问题和方案"><a href="#问题和方案" class="headerlink" title="问题和方案"></a>问题和方案</h2><p>大文件上传的普遍方案是文件分片上传</p><p>如果把文件上传看做是一个不可分割的事务, 那么分片的目标就是把一个耗时的大事务划分为一个一个的小事务</p><p>由于使用 BFF 层来承接前端的文件请求, 因此需要开通前后端所有跟文件上传的阻碍</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/5.png"></p><p>分片上传的主要障碍集中在</p><ul><li>如何减少页面阻塞</li><li>前后端如何协调</li><li>代码如何组织</li><li>前端代码中的复杂逻辑</li><li>BFF 代码中的复杂逻辑</li></ul><h3 id="如何减少页面阻塞"><a href="#如何减少页面阻塞" class="headerlink" title="如何减少页面阻塞"></a>如何减少页面阻塞</h3><p>分片上传的一个首要目标就是要尽量避免相同的分片重复上传. 服务器必须要能够识别来自各个客户端的各个上传请求中, 是否存在与过去分片相同的上传请求</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/6.png"></p><p>服务器如何识别那些分片是相同的呢?</p><p>首先需要对相同下一个定义: 文件内容一样即为相同<br>可以对文件内容进行二进制的对比是一个非常耗时的操作, 于是可以可以选择基于内容的<code>hash</code>表示对比</p><blockquote><p>hash 是一种算法, 可以将任何长度的数据转化成定长的数据</p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/7.png"></p><p>不仅针对分片如此, 针对整个文件也是如此<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/8.png"></p><p>可见, 客户端需要承担两件重要的事情:</p><ol><li>对文件进行分片. 并计算每个分片的 hash 值</li><li>根据所有的 hash 值, 计算整个文件的 hash 值</li></ol><p>而计算 Hash 是一件 CPU 密集型的操作, 如果不加处理将会导致长时间的阻塞主线程</p><p>一般的做法</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/9.png"></p><p>为了解决这个问题, 可以对大文件上传做一个假设: 绝大部分的文件上传都是新文件上传</p><p>有了这个假设, 我们就无须等待整体 hash 的计算结果, 直接上传分片即可, 同时可以把分片操作使用多线程+异步的方式进行上传处理<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/10.png"></p><p>这样做的好处是: 页面完全无阻塞, 也无须等待整体 hash 即可启动上传, 相比于传统方案</p><ol><li>对于新文件上传可以缩短整体上传时间, 消除页面的阻塞</li><li>对于旧文件上传可能会产生一些无效的请求, 但这些请求仅传递的是 hash, 并不真实上传文件数据, 所以对网络和服务器影响很小, 加上旧文件上传情况相对较少, 所以整体可以忽略不计</li></ol><h3 id="前后端如何协调"><a href="#前后端如何协调" class="headerlink" title="前后端如何协调"></a>前后端如何协调</h3><p>文件上传涉及到前后端的交互, 需要建立一个标准的通信协议, 通过协议要能完成下面几件核心交互:</p><ul><li>创建文件</li><li>hash 校验</li><li>分片数据上传</li><li>分片合并</li></ul><h4 id="创建文件协议"><a href="#创建文件协议" class="headerlink" title="创建文件协议"></a>创建文件协议</h4><p>当客户端发送分片到服务器,需要告知服务器分片属于那一次文件上传,因此需要一个唯一标识来标识某一次文件上传</p><p>创建文件协议就是用于获取文件上传的唯一标识</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/11.png"></p><ul><li>uploadToken: 文件上传的唯一标识</li><li>chunkSize: 分片大小, 单位字节</li></ul><h4 id="hash-校验协议"><a href="#hash-校验协议" class="headerlink" title="hash 校验协议"></a>hash 校验协议</h4><p>客户端有时需要校验单个分片或整个文件的 hash, 服务器需要告知客户端它们目的的具体情况</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/12.png"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/13.png"></p><ul><li>Upload-Hash-Type: 取值 chunk 或 file, 分别代表分片 hash 和文件整体 hash</li><li>Upload-Hash: 分片或文件的具体 hash 值</li><li>hasFile: 指示服务器是否已经存储了对应的分片或文件</li><li>rest: 当校验文件 hash 时持有的响应字段, 指示该文件还剩余那些 hash 没有上传</li><li>url: 当校验文件 hash 时持有响应字段, 如果该文件已经完成上传出现字段, 表示文件而请求地址</li></ul><h4 id="分片数据上传协议"><a href="#分片数据上传协议" class="headerlink" title="分片数据上传协议"></a>分片数据上传协议</h4><p>通过此协议. 上传具体的文件分片数据<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/14.png"></p><h4 id="分片合并协议"><a href="#分片合并协议" class="headerlink" title="分片合并协议"></a>分片合并协议</h4><p>当所有的分片全部上传后, 通过此协议请求服务器完成分片合并</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/15.png"></p><h3 id="代码如何组织"><a href="#代码如何组织" class="headerlink" title="代码如何组织"></a>代码如何组织</h3><p>大文件上传 SDK 的搭建分为三层</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/16.png"></p><ul><li>上传协议: 约定前后端的通信格式</li><li>upload-core: 基于协议的 API, 提供协议字段的创建, 读取, 前后端通用工具函数等核心功能</li><li>upload-client: 应用于客户端的 SDK</li><li>upload-server: 用于 BFF 的 SDK</li></ul><h4 id="upload-core-中的通用函数"><a href="#upload-core-中的通用函数" class="headerlink" title="upload-core 中的通用函数"></a>upload-core 中的通用函数</h4><p><strong>EventEmitter</strong></p><p>统一前后端涉及到的基于各种事件的处理, 使用<strong>发布订阅模式</strong>提供统一的 EventEmitter 类</p><blockquote><p>前端可能出现的各种事件: 上传进度改变事件, 上传暂停&#x2F;恢复事件等等<br>后端可能出现的各种事件: 分片写入完成事件, 分布合并完成事件等等</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">EventEmitter</span>&lt;T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">events</span>: <span class="title class_">Map</span>&lt;T, <span class="title class_">Set</span>&lt;<span class="title class_">Function</span>&gt;&gt;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">on</span>(<span class="params">event: T, listener: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">has</span>(event)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">set</span>(event, <span class="keyword">new</span> <span class="title class_">Set</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(event)?.<span class="title function_">add</span>(listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">off</span>(<span class="params">event: T, listener: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">has</span>(event)) <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(event)?.<span class="title function_">delete</span>(listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">once</span>(<span class="params">event: T, listener: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onceListener</span> = (<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">listener</span>(...args)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(event, listener)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">on</span>(event, listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">event: T, ...args: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">has</span>(event)) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(event)?.<span class="title function_">forEach</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">listener</span>(...args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TaskQueue</strong></p><p>为了支撑前后端的多任务并发执行, 提供 TaskQueue 类</p><blockquote><p>前端可能的并发执行: 并发请求<br>后端可能的并发执行: 并发的分片 Hash 校验</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可并发执行的任务队列</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TaskQueue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span>&lt;<span class="string">&#x27;start&#x27;</span> | <span class="string">&#x27;pause&#x27;</span> | <span class="string">&#x27;drain&#x27;</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 待执行的任务</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">tasks</span>: <span class="title class_">Set</span>&lt;<span class="title class_">Task</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="comment">// 当前正在执行的任务数</span></span><br><span class="line">  <span class="keyword">private</span> currentCount = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 任务状态</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">status</span>: <span class="string">&#x27;paused&#x27;</span> | <span class="string">&#x27;running&#x27;</span> = <span class="string">&#x27;paused&#x27;</span></span><br><span class="line">  <span class="comment">// 最大并发数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">concurency</span>: <span class="built_in">number</span> = <span class="number">4</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">concurency</span> = <span class="variable language_">this</span>.<span class="property">concurency</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加任务</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">...tasks: Task[]</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> t <span class="keyword">of</span> tasks) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">add</span>(t)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加任务并执行启动</span></span><br><span class="line">  <span class="title function_">addAndStart</span>(<span class="params">...tasks: Task[]</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">add</span>(...tasks)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">start</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 启动任务</span></span><br><span class="line">  <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;running&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="property">size</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 当前无任务 触发drain事件</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;drain&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置任务状态为running</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;running&#x27;</span></span><br><span class="line">    <span class="comment">// 触发start事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">    <span class="comment">// 开始执行下一个任务</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">runNext</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">takeHeadTask</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> task = <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">values</span>().<span class="title function_">next</span>().<span class="property">value</span></span><br><span class="line">    <span class="keyword">if</span> (task) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">delete</span>(task)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行下一个任务</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">runNext</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> !== <span class="string">&#x27;running&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果整体的任务状态不是running 结束</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentCount</span> &gt;= <span class="variable language_">this</span>.<span class="property">concurency</span>) &#123;</span><br><span class="line">      <span class="comment">// 并发已满 结束</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取出第一个任务</span></span><br><span class="line">    <span class="keyword">const</span> task = <span class="variable language_">this</span>.<span class="title function_">takeHeadTask</span>()</span><br><span class="line">    <span class="keyword">if</span> (!task) &#123;</span><br><span class="line">      <span class="comment">// 没有任务了</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;paused&#x27;</span> <span class="comment">// 暂停执行</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;drain&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentCount</span>++</span><br><span class="line">    <span class="comment">// 执行任务</span></span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(task.<span class="title function_">run</span>()).<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 任务执行完成后, 当前任务数执行下一个任务</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentCount</span>--</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">runNext</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 暂停</span></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;paused&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;pause&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="前端-upload-client-代码中的复杂问题"><a href="#前端-upload-client-代码中的复杂问题" class="headerlink" title="前端(upload-client)代码中的复杂问题"></a>前端(upload-client)代码中的复杂问题</h4><p>前端涉及到两个核心问题:</p><ul><li>如何对文件分片</li><li>如何控制请求</li></ul><h5 id="如何对文件分片"><a href="#如何对文件分片" class="headerlink" title="如何对文件分片"></a>如何对文件分片</h5><p>首先要实现分片对象的处理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chunk.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Chunk</span> &#123;</span><br><span class="line">  <span class="attr">blob</span>: <span class="title class_">Blob</span> <span class="comment">// 分片的二进制数据</span></span><br><span class="line">  <span class="attr">start</span>: <span class="built_in">number</span> <span class="comment">// 分片的起始位置</span></span><br><span class="line">  <span class="attr">end</span>: <span class="built_in">number</span> <span class="comment">// 分片的结束位置</span></span><br><span class="line">  <span class="attr">hash</span>: <span class="built_in">string</span> <span class="comment">// 分片的hash值</span></span><br><span class="line">  <span class="attr">index</span>: <span class="built_in">number</span> <span class="comment">// 分片在文件的索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个不带hash的chunk</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createChunk</span>(<span class="params"></span></span><br><span class="line"><span class="params">  file: File,</span></span><br><span class="line"><span class="params">  index: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  chunkSize: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Chunk</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> start = index * chunkSize</span><br><span class="line">  <span class="keyword">const</span> end = <span class="title class_">Math</span>.<span class="title function_">min</span>((index + <span class="number">1</span>) * chunkSize, file.<span class="property">size</span>)</span><br><span class="line">  <span class="keyword">const</span> blob = file.<span class="title function_">slice</span>(start, end)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    blob,</span><br><span class="line">    start,</span><br><span class="line">    end,</span><br><span class="line">    <span class="attr">hash</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    index</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算chunk的hash值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">calcChunkHash</span>(<span class="params">chunk: Chunk</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>.<span class="title class_">ArrayBuffer</span>()</span><br><span class="line">    <span class="keyword">const</span> fileReader = <span class="keyword">new</span> <span class="title class_">FileReader</span>()</span><br><span class="line">    fileReader.<span class="property">onload</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      spark.<span class="title function_">append</span>(e.<span class="property">target</span>?.<span class="property">result</span> <span class="keyword">as</span> <span class="title class_">ArrayBuffer</span>)</span><br><span class="line">      <span class="title function_">resolve</span>(spark.<span class="title function_">end</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    fileReader.<span class="title function_">readAsArrayBuffer</span>(chunk.<span class="property">blob</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来, 要对整个文件进行分片, 分片的方式有很多, 如:</p><ul><li>普通分片</li><li>基于多线程的分片</li><li>基于主线程时间切片的分片 (React Fiber)</li><li>其他分片模式</li></ul><p>考虑到通用性, 必须要向上层提供不同的分片模式, 同时还要允许上层自定义分片模式, 因此在设计上, 使用基于抽象类的<strong>模板模式</strong>来完成处理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ChunkSplitorEvents</span> = <span class="string">&#x27;chunks&#x27;</span> | <span class="string">&#x27;wholeHash&#x27;</span> | <span class="string">&#x27;drain&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ChunkSplitor</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span>&lt;<span class="title class_">ChunkSplitorEvents</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">chunkSize</span>: <span class="built_in">number</span> <span class="comment">// 分片大小 (单位字节)</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">file</span>: <span class="title class_">File</span> <span class="comment">// 待分片的文件</span></span><br><span class="line">  <span class="keyword">protected</span> hash?: <span class="built_in">string</span> <span class="comment">// 整个文件的hash</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">chunks</span>: <span class="title class_">Chunk</span>[] <span class="comment">// 分片列表</span></span><br><span class="line">  <span class="keyword">private</span> handleChunkCount = <span class="number">0</span> <span class="comment">// 已计算hash的分片数据</span></span><br><span class="line">  <span class="keyword">private</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>() <span class="comment">// 计算Hash的工具</span></span><br><span class="line">  <span class="keyword">private</span> hasSplited = <span class="literal">false</span> <span class="comment">// 是否已经分片</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">file: File, chunkSize: <span class="built_in">number</span> = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">file</span> = file</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chunkSize</span> = chunkSize</span><br><span class="line">    <span class="comment">// 获取分片数组</span></span><br><span class="line">    <span class="keyword">const</span> chunkCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="variable language_">this</span>.<span class="property">file</span>.<span class="property">size</span> / <span class="variable language_">this</span>.<span class="property">chunkSize</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chunks</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(chunkCount)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">_, index</span>) =&gt;</span> <span class="title function_">createChunk</span>(<span class="variable language_">this</span>.<span class="property">file</span>, index, <span class="variable language_">this</span>.<span class="property">chunkSize</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">split</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasSplited</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasSplited</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> emitter = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;<span class="string">&#x27;chunks&#x27;</span>&gt;()</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">chunkHanlder</span> = (<span class="params">chunks: Chunk[]</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chunks&#x27;</span>, chunks)</span><br><span class="line">      chunks.<span class="title function_">forEach</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">spark</span>.<span class="title function_">append</span>(chunk.<span class="property">hash</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handleChunkCount</span> += chunks.<span class="property">length</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handleChunkCount</span> === <span class="variable language_">this</span>.<span class="property">chunks</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="comment">// 计算完成</span></span><br><span class="line">        emitter.<span class="title function_">off</span>(<span class="string">&#x27;chunks&#x27;</span>, chunkHanlder)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;wholeHash&#x27;</span>, <span class="variable language_">this</span>.<span class="property">spark</span>.<span class="title function_">end</span>())</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">spark</span>.<span class="title function_">destroy</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;drain&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    emitter.<span class="title function_">on</span>(<span class="string">&#x27;chunks&#x27;</span>, chunkHanlder)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">calcHash</span>(<span class="variable language_">this</span>.<span class="property">chunks</span>, emitter)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">calcHash</span>(<span class="attr">chunks</span>: <span class="title class_">Chunk</span>[], <span class="attr">emitter</span>: <span class="title class_">EventEmitter</span>&lt;<span class="string">&#x27;chunks&#x27;</span>&gt;): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 分片完成后一些需要销毁的工作</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">dispose</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于此抽象类, 即可实现多种形式的分片模式, 每种模式只需要继承<code>ChunkSplitor</code>, 实现计算分片的 hash 即可</p><p>比如: 基于多线程的分片类可以非常简单的实现:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MutilThreadSplitor.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MutilThreadSplitor</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ChunkSplitor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">workers</span>: <span class="title class_">Worker</span>[] = <span class="keyword">new</span> <span class="title class_">Array</span>(navigator.<span class="property">hardwareConcurrency</span> || <span class="number">4</span>)</span><br><span class="line">    .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">    .<span class="title function_">map</span>(</span><br><span class="line">      <span class="function">() =&gt;</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&#x27;./SplitWorker.ts&#x27;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>), &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;module&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    )</span><br><span class="line">  <span class="title function_">calcHash</span>(<span class="attr">chunks</span>: <span class="title class_">Chunk</span>[], <span class="attr">emitter</span>: <span class="title class_">EventEmitter</span>&lt;<span class="string">&#x27;chunks&#x27;</span>&gt;): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> workerSize = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(chunks.<span class="property">length</span> / <span class="variable language_">this</span>.<span class="property">workers</span>.<span class="property">length</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">workers</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> worker = <span class="variable language_">this</span>.<span class="property">workers</span>[i]</span><br><span class="line">      <span class="keyword">const</span> start = i * workerSize</span><br><span class="line">      <span class="keyword">const</span> end = <span class="title class_">Math</span>.<span class="title function_">min</span>((i + <span class="number">1</span>) * workerSize, chunks.<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">const</span> workerChunks = chunks.<span class="title function_">slice</span>(start, end)</span><br><span class="line">      worker.<span class="title function_">postMessage</span>(workerChunks)</span><br><span class="line">      worker.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        emitter.<span class="title function_">emit</span>(<span class="string">&#x27;chunks&#x27;</span>, e.<span class="property">data</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">dispose</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">workers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">worker</span>) =&gt;</span> worker.<span class="title function_">terminate</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SplitWorker.ts</span></span><br><span class="line">onmessage = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> chunks = e.<span class="property">data</span> <span class="keyword">as</span> <span class="title class_">Chunk</span>[]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> chunk <span class="keyword">of</span> chunks) &#123;</span><br><span class="line">    <span class="title function_">calcChunkHash</span>(chunk).<span class="title function_">then</span>(<span class="function">(<span class="params">hash</span>) =&gt;</span> &#123;</span><br><span class="line">      chunk.<span class="property">hash</span> = hash</span><br><span class="line">      <span class="title function_">postMessage</span>([chunk])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="如何控制请求"><a href="#如何控制请求" class="headerlink" title="如何控制请求"></a>如何控制请求</h5><p>对请求的控制涉及多个方面的问题:</p><ol><li><strong>如何充分利用带宽</strong><br>分片上传中涉及到大量的请求发送, 这些请求即不能一起发送造成网络阻塞, 也不能依次发送浪费带宽资源, 因此需要有请求并发控制的机制<br>**方案: ** 利用基础库的 TaskQueue 实现并发控制</li><li>如何与上层请求库解耦<br>考虑到通用性, 上层应用可能会使用各种请求库发送请求, 因此前端 SDK 不能绑定任何的请求库<br><strong>方案:</strong> 使用<strong>策略模式</strong>对请求库解耦</li></ol><p>比如 请求策略</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求策略</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">RequestStrategy</span> &#123;</span><br><span class="line">  <span class="comment">// 文件创建请求, 返回token</span></span><br><span class="line">  <span class="title function_">createFile</span>(<span class="attr">file</span>: <span class="title class_">File</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">  <span class="comment">// 分片上传请求</span></span><br><span class="line">  <span class="title function_">uploadChunk</span>(<span class="attr">chunk</span>: <span class="title class_">Chunk</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;</span><br><span class="line">  <span class="comment">// 文件合并请求, 返回文件url</span></span><br><span class="line">  <span class="title function_">mergeFile</span>(<span class="attr">token</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">  <span class="comment">// hash校验请求</span></span><br><span class="line">  patchHash&lt;T <span class="keyword">extends</span> <span class="string">&#x27;file&#x27;</span> | <span class="string">&#x27;chunk&#x27;</span>&gt;(</span><br><span class="line">    <span class="attr">token</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">hash</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">type</span>: T</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;</span><br><span class="line">    T <span class="keyword">extends</span> <span class="string">&#x27;file&#x27;</span></span><br><span class="line">      ? &#123; <span class="attr">hasFile</span>: <span class="built_in">boolean</span> &#125;</span><br><span class="line">      : &#123; <span class="attr">hasFile</span>: <span class="built_in">boolean</span>; <span class="attr">rest</span>: <span class="built_in">number</span>[]; <span class="attr">url</span>: <span class="built_in">string</span> &#125;</span><br><span class="line">  &gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求控制</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">requestStrategy</span>: <span class="title class_">RequestStrategy</span> <span class="comment">// 请求策略，没有传递则使用默认策略</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">splitStrategy</span>: <span class="title class_">ChunkSplitor</span> <span class="comment">// 分片策略，没有传递则默认多线程分片</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">taskQueue</span>: <span class="title class_">TaskQueue</span> <span class="comment">// 任务队列</span></span><br><span class="line">  <span class="comment">// 其他属性略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取文件token</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">token</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">createFile</span>(<span class="variable language_">this</span>.<span class="property">file</span>)</span><br><span class="line">    <span class="comment">// 分片事件监听</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">splitStrategy</span>.<span class="title function_">on</span>(<span class="string">&#x27;chunks&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleChunks</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">splitStrategy</span>.<span class="title function_">on</span>(<span class="string">&#x27;wholeHash&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleWholeHash</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分片事件处理</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">handleChunks</span>(<span class="params">chunks: Chunk[]</span>) &#123;</span><br><span class="line">    <span class="comment">// 分片上传任务加入队列</span></span><br><span class="line">    chunks.<span class="title function_">forEach</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">taskQueue</span>.<span class="title function_">addAndStart</span>(<span class="keyword">new</span> <span class="title class_">Task</span>(<span class="variable language_">this</span>.<span class="property">uploadChunk</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>), chunk))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadChunk</span>(<span class="params">chunk: Chunk</span>) &#123;</span><br><span class="line">    <span class="comment">// hash校验</span></span><br><span class="line">    <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">patchHash</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">token</span>,</span><br><span class="line">      chunk.<span class="property">hash</span>,</span><br><span class="line">      <span class="string">&#x27;chunk&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (resp.<span class="property">hasFile</span>) &#123;</span><br><span class="line">      <span class="comment">// 文件已存在</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分片上传</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">uploadChunk</span>(chunk, <span class="variable language_">this</span>.<span class="property">uploadEmitter</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 整体hash事件处理</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">handleWholeHash</span>(<span class="params">hash: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="comment">// hash校验</span></span><br><span class="line">    <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">patchHash</span>(<span class="variable language_">this</span>.<span class="property">token</span>, hash, <span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (resp.<span class="property">hasFile</span>) &#123;</span><br><span class="line">      <span class="comment">// 文件已存在</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;end&#x27;</span>, resp.<span class="property">url</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据resp.rest重新编排后续任务</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="后端代码中的复杂问题"><a href="#后端代码中的复杂问题" class="headerlink" title="后端代码中的复杂问题"></a>后端代码中的复杂问题</h4><p>相对于客户端而言, 服务器面临着更大的挑战</p><h5 id="如何隔离不同的文件上传"><a href="#如何隔离不同的文件上传" class="headerlink" title="如何隔离不同的文件上传?"></a>如何隔离不同的文件上传?</h5><p>在创建文件协议中, 服务器使用 uuid + jwt 生成一个不可纂改的唯一编码, 用于标识不同的文件上传</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/17.png"></p><h5 id="如何保证分片不重复"><a href="#如何保证分片不重复" class="headerlink" title="如何保证分片不重复?"></a>如何保证分片不重复?</h5><p>重复的含义是指:</p><ol><li>不保存重复分片</li><li>不上传重复分片</li></ol><p>这就要求分片<strong>跨文件唯一</strong>, 并且<strong>永不删除</strong></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/18.png"></p><p>也就是: <strong>服务器并不保存合并之后的文件, 仅记录文件中的分片顺序</strong></p><h5 id="合并分片到底做什么"><a href="#合并分片到底做什么" class="headerlink" title="合并分片到底做什么?"></a>合并分片到底做什么?</h5><p>合并会造成很多问题, 比如:</p><ol><li>极其耗时(需要找到文件并组装)</li><li>数据冗余</li></ol><p>所以服务器并不发生真正的合并, 而是在数据库中记录文件中包含的分片</p><p>因此,合并操作时, 服务器仅做简单的处理:</p><ol><li>校验文件大小</li><li>校验文件 hash</li><li>标记文件状态</li><li>生成文件访问地址</li><li>…</li></ol><p>上面操作效率很高</p><h5 id="实际访问文件"><a href="#实际访问文件" class="headerlink" title="实际访问文件"></a>实际访问文件</h5><p>由于服务器并未发生真正的文件合并, 当后续请求该文件时, 服务器需要动态处理, 具体的做法是:</p><ol><li>服务器收到对文件的请求, 并在数据库中找到了对应的文件</li><li>服务器读取文件的所有分片 ID, 依次找到对应的分片文件</li><li>服务器利用 TaskQueue 的并发控制能力, 逐步产生文件读取流, 并利用管道直接输出到网络 I&#x2F;O</li></ol><h1 id="ABT-在前端基建中的实践"><a href="#ABT-在前端基建中的实践" class="headerlink" title="ABT 在前端基建中的实践"></a>ABT 在前端基建中的实践</h1><h2 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h2><p>产品有时无法确定哪种设计方案更好，因此希望前端能够同时上线多个产品方案，根据某套规则将用户导流到不同的方案。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/19.png"></p><p>在用户体验理论研究中，这种做法称之为 A&#x2F;B Testing（后续简称 ABT）。</p><p>一次 ABT 实验会生成至少两套方案（对照组&#x2F;实验组），并且可以允许多个实验共存。</p><p>ABT 实验会涉及多个岗位的协调，包含：前端、后端、测试、运维、产品，其中起主要作用的是产品和前端。</p><h2 id="问题和方案-1"><a href="#问题和方案-1" class="headerlink" title="问题和方案"></a>问题和方案</h2><p>ABT 为前端带来诸多的挑战，其中包括：</p><h3 id="如何协作？"><a href="#如何协作？" class="headerlink" title="如何协作？"></a>如何协作？</h3><p>在一个实验生命周期内涉及到哪些角色，角色之间是如何协作的？</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/20.png"></p><h3 id="前端如何开发？"><a href="#前端如何开发？" class="headerlink" title="前端如何开发？"></a>前端如何开发？</h3><p>实验具有以下几个特点：</p><ol><li>多个实验共存<br>产品可能会先后发起几十个甚至上百个实验，不同的实验有不同的分流规则，每个实验又有多个对照组</li><li>实验是精确到组件的，一个实验对应到多个前端组件<br>一个组件不同的对照组之间的差异是灵活的</li><li>实验是频繁的</li><li>用户参与实验必须是无感的</li><li>实验推全后只保留一个对照组</li></ol><h4 id="流程和结构"><a href="#流程和结构" class="headerlink" title="流程和结构"></a>流程和结构</h4><p>ABT 运作流程</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/21.png"></p><p>ABT SDK 的结构</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/22.png" alt="image-20240306191832940"></p><p>整个 ABT-SDK 包含了诸多 API 和工具，为应用开发提供支撑，其中</p><ul><li>ABTCore： 提供 ABT 最底层的核心功能，比如实验信息、分流控制、代码剪枝、数据决策等等</li><li>ABT-Server： 针对服务器提供一些中间件</li><li>ABT-Vue&#x2F;ABT-React： 针对前端两种框架提供一些组件、仓库、路由等</li><li>ABT-Webpack&#x2F;ABT-Vite： 针对前端两种常见构建工具，提供一些插件集成，比如 ESLint 工具、PostCSS 插件、命令行工具等等</li></ul><h4 id="如何分流？"><a href="#如何分流？" class="headerlink" title="如何分流？"></a>如何分流？</h4><ol><li>使用 Redis 存储当前每个实验不同对照组的参与人数</li><li>使用浏览器指纹+用户身份保证同一用户对同一实验仅参与一个组<br>两种做法<ul><li>将指纹+用户身份+组打包成 JWT 发送给客户端（不精准，成本低）</li><li>使用数据库保存映射关系（精准，成本高）</li></ul></li><li>按照规则中的分流比例为新用户分配组别</li><li>将所有实验的 ID，以及每个组别的编号下发到客户端</li></ol><h4 id="如何改变运行代码？"><a href="#如何改变运行代码？" class="headerlink" title="如何改变运行代码？"></a>如何改变运行代码？</h4><p>实验和组别对运行时的影响主要是渲染组件的不同，但也有可能对其他代码造成影响。</p><p>由于每次实验所产生的差异是极其灵活的，因此难以使用一种标准化的静态格式来描述差异，这就不可避免的造成了对业务代码的侵入。</p><p>基建的一个重要目标就是要将这种侵入最小化、标准化。</p><p><strong>提供高阶组件屏蔽组件差异</strong></p><p>vue 示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ABTesting name=&quot;exp1&quot;&gt;</span><br><span class="line">	&lt;template #default&gt;</span><br><span class="line">		&lt;DefaultComp&gt;&lt;/DefaultComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupB&gt;</span><br><span class="line">  	&lt;GroupBComp&gt;&lt;/GroupBComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupC&gt; </span><br><span class="line">  	&lt;GroupCComp&gt;&lt;/GroupCComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">&lt;/ABTesting&gt;</span><br></pre></td></tr></table></figure><p>react 示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ABTesting</span><br><span class="line">  name=&quot;exp1&quot;</span><br><span class="line">  groupB=&#123;&lt;GroupBComp&gt;&lt;/GroupBComp&gt;&#125;</span><br><span class="line">  groupC=&#123;&lt;GroupCComp&gt;&lt;/GroupCComp&gt;&#125;</span><br><span class="line">  &gt;</span><br><span class="line">	&lt;DefaultComp&gt;&lt;/DefaultComp&gt;</span><br><span class="line">&lt;/ABTesting&gt;</span><br></pre></td></tr></table></figure><p><strong>提供高阶函数屏蔽 API 差异</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> utilMethod = <span class="title class_">ABTCore</span>.<span class="title function_">choose</span>(</span><br><span class="line">  <span class="string">&#x27;exp1&#x27;</span>,</span><br><span class="line">  defaultMethod,</span><br><span class="line">  groupBMethod,</span><br><span class="line">  groupCMethod</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">ABTCore</span>.<span class="title function_">call</span>(<span class="string">&#x27;exp1&#x27;</span>, defaultMethod, groupBMethod, groupCMethod)</span><br></pre></td></tr></table></figure><p><strong>使用自定义指令屏蔽 CSS 差异</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* style.css */</span></span><br><span class="line"><span class="keyword">@ab-testing</span> exp1 &#123;</span><br><span class="line">  default &#123;</span><br><span class="line">    <span class="comment">/* default styles */</span></span><br><span class="line">    <span class="selector-class">.a</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  groupB &#123;</span><br><span class="line">    <span class="comment">/* groupB styles */</span></span><br><span class="line">    <span class="selector-class">.a</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用自定义的 PostCSS 插件，会将上面的代码转换为</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exp1-default-<span class="selector-tag">a</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line">exp1-groupb-<span class="selector-tag">a</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与此同时，我们也改变了 CSS Modules。</p><p>默认情况下，开启 CSS Modules 后，上面的代码会被转换为下面的 JS</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="string">&#x27;exp1-default-a&#x27;</span>: <span class="string">&#x27;hash1&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;exp1-groupB-a&#x27;</span>: <span class="string">&#x27;hash2&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们对此作了改变，将代码变成了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; chooseValue &#125; <span class="keyword">from</span> <span class="string">&#x27;ABTCore&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">chooseValue</span>(<span class="string">&#x27;exp1&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">default</span>: &#123;</span><br><span class="line">      <span class="attr">a</span>: <span class="string">&#x27;hash1&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">groupB</span>: &#123;</span><br><span class="line">      <span class="attr">a</span>: <span class="string">&#x27;hash2&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><h4 id="实验推全后如何处理？"><a href="#实验推全后如何处理？" class="headerlink" title="实验推全后如何处理？"></a>实验推全后如何处理？</h4><p>当产品完成实验后，会选定一种方案进行推全。</p><p>此时，会涉及到对应实验的代码如何剪枝的问题？</p><p>由于实验 SDK 并不向外界暴露当前用户所处的实验分组，因此，业务开发者要根据不同分组进行不同处理的代码逻辑必须使用实验 SDK 才能完成。</p><p>这就对自动化的实验推全提供了基础，由于所有的实验代码都是使用 SDK 完成的，因此可以通过一个简洁的逻辑即可完成自动化实验推全：</p><ol><li>实验 SDK 为各种构建工具提供插件</li><li>打包时，插件会通过代码分析（AST），找出当前哪些文件对应到哪些实验</li><li>插件会对照最新的实验信息，找到已经被推全的实验</li><li>插件定位到所有与该实验有关的源码文件</li><li>插件提示开发者，是否对已推全的实验进行剪枝</li><li>开发者确认后，插件自动修改 AST 完成剪枝</li></ol><p>通过 AST 完成剪枝逻辑是非常容易的</p><p>比如针对组件的剪枝</p><p>剪枝前</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ABTesting name=&quot;exp1&quot;&gt;</span><br><span class="line">	&lt;template #default&gt;</span><br><span class="line">		&lt;DefaultComp&gt;&lt;/DefaultComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupB&gt;</span><br><span class="line">  	&lt;GroupBComp&gt;&lt;/GroupBComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupC&gt; </span><br><span class="line">  	&lt;GroupCComp&gt;&lt;/GroupCComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">&lt;/ABTesting&gt;</span><br></pre></td></tr></table></figure><p>剪枝后（假设将 groupB 推全）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;GroupBComp&gt;&lt;/GroupBComp&gt;</span><br></pre></td></tr></table></figure><h4 id="细节问题？"><a href="#细节问题？" class="headerlink" title="细节问题？"></a>细节问题？</h4><p><strong>白屏问题</strong></p><p>对于一个 CSR 应用，它的组件渲染取决于所处的组别，而它所属哪个组别又必须通过网络通信才能确定。</p><p>这就导致了首屏渲染的白屏问题。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/23.png"></p><p>而我们观察到整个应用中实际上只有部分组件会参与到实验，对于没有参与到实验的组件是不需要等待分组信息的。</p><p>因此，我们将参与到实验的组件制作为异步组件，从而可以不影响其他组件的渲染。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/24.png" alt="image-20240306194033162"></p><p><strong>代码检查问题</strong></p><p>由于实验推全时需要对代码进行剪枝，剪枝发生在编译时态，它通过 AST 检查代码中包含的 ABT-SDK 代码完成，而大部分 ABT-SDK 中的 API 都需要绑定实验名称，例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ABTCore</span>.<span class="title function_">call</span>(<span class="string">&#x27;exp1&#x27;</span>, defaultMethod, groupBMethod, groupCMethod)</span><br></pre></td></tr></table></figure><p>如果实验名称来自于一个变量或表达式或者其他需要在运行时才能确定的值，这就会导致剪枝失败。</p><p>因此我们制作了 ESLint 插件来约束开发者必须使用字面量或者其他在编译时态能确定的值。</p><p><strong>开发规范</strong></p><p>ABT-SDK 不会暴露用户的分组信息给开发者，这主要是考虑到开发者可能写出下面的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (用户的分组 === <span class="string">&#x27;B&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// 代码1</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (用户的分组 === <span class="string">&#x27;C&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// 代码2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的代码无法被代码剪枝工具察觉，容易在实验推全后仍然保留在代码中，虽然功能性不受影响，但会逐步降低代码的可维护性。</p><p>以上是不暴露的主要原因。</p><p>但开发者仍然有可能间接的获取到用户的分组，比如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="title class_">ABTCore</span>.<span class="title function_">data</span>(<span class="string">&#x27;exp1&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">groupB</span>: <span class="string">&#x27;B&#x27;</span>,</span><br><span class="line">  <span class="attr">groupC</span>: <span class="string">&#x27;C&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> (data === <span class="string">&#x27;B&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// 代码1</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="string">&#x27;C&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// 代码2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种代码很难通过自动化工具检查处理，因此需要通过开发规范来约束：</p><p><em>所有跟实验相关的处理，必须通过 ABT-SDK 完成</em></p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">月晕</div><div class="post-copyright__author_desc">生命是有光的</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.yueyun.site/posts/8f49bd54.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://blog.yueyun.site/posts/8f49bd54.html")'>前端技术探索</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.yueyun.site/posts/8f49bd54.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.yueyun.site" target="_blank">月晕</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E5%89%8D%E7%AB%AF/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span>前端<span class="categoryesPageCount">10</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/JavaScript/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>JavaScript<span class="tagsPageCount">10</span></a><a class="post-meta__box__tags" href="/tags/React/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>React<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>前端<span class="tagsPageCount">15</span></a><a class="post-meta__box__tags" href="/tags/TypeScript/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TypeScript<span class="tagsPageCount">2</span></a></div></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/ac8590ca.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/5370198c46b7e6193aad423d755464fd5aa83820_raw.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">go 语言速成</div></div></a></div><div class="next-post pull-right"><a href="/posts/f576a3fe.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/8c52b9660688cedcc40580545cef9ba4.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">记录第一次字节实习offer</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/938f2f9c.html" title="React Native开坑"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1702557508740.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-15</div><div class="title">React Native开坑</div></div></a></div><div><a href="/posts/9ac48510.html" title="React学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1701613946910.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-12</div><div class="title">React学习</div></div></a></div><div><a href="/posts/49ae955a.html" title="React 源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/wallpaper/2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-15</div><div class="title">React 源码分析</div></div></a></div><div><a href="/posts/d681bdaf.html" title="TypeScript语言学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/liang.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-22</div><div class="title">TypeScript语言学习</div></div></a></div><div><a href="/posts/317b894e.html" title="Vue学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1702396713207.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-12</div><div class="title">Vue学习</div></div></a></div><div><a href="/posts/ea5e4ee3.html" title="Vue部分源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1700908595951.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-25</div><div class="title">Vue部分源码分析</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display:none">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__decoration"><img class="avatar-decoration-1" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d1.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"><img class="avatar-decoration-2" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d2.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"><img class="avatar-decoration-3" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d3.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"><img class="avatar-decoration-4" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d4.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">月晕</h1><div class="author-info__desc">生命是有光的</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=3514392356&amp;website=www.oicqzone.com" target="_blank" title="QQ"><i class="anzhiyufont anzhiyu-icon-qq"></i></a><a class="social-icon faa-parent animated-hover" href="https://github.com/apprehen" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/554370301" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E5%B0%81%E8%A3%85%E5%92%8C%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">网络库的封装和实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%92%8C%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">方案和设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E7%BB%93%E6%9E%84%E7%9A%84%E5%AE%8F%E8%A7%82%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.1.</span> <span class="toc-text">库结构的宏观设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">请求缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%BB%93%E6%9E%9C%E6%80%8E%E4%B9%88%E5%AD%98-%E5%AD%98%E5%9C%A8%E9%82%A3%E4%BA%9B%E5%9C%B0%E6%96%B9-%E7%BC%93%E5%AD%98%E9%94%AE%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">请求结果怎么存? 存在那些地方? 缓存键是什么?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%BD%95%E6%97%B6%E5%A4%B1%E6%95%88-%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E8%BF%98%E6%98%AF%E5%85%B6%E4%BB%96%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">缓存何时失效? 基于时间还是其他条件?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">如何实现?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%B9%82%E7%AD%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">请求幂等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.4.</span> <span class="toc-text">样本代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.</span> <span class="toc-text">大文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-1"><span class="toc-number">2.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%92%8C%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.</span> <span class="toc-text">问题和方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E9%A1%B5%E9%9D%A2%E9%98%BB%E5%A1%9E"><span class="toc-number">2.2.1.</span> <span class="toc-text">如何减少页面阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83"><span class="toc-number">2.2.2.</span> <span class="toc-text">前后端如何协调</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">创建文件协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash-%E6%A0%A1%E9%AA%8C%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">hash 校验协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">分片数据上传协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%90%88%E5%B9%B6%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">分片合并协议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%A6%82%E4%BD%95%E7%BB%84%E7%BB%87"><span class="toc-number">2.2.3.</span> <span class="toc-text">代码如何组织</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#upload-core-%E4%B8%AD%E7%9A%84%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">upload-core 中的通用函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF-upload-client-%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%A4%8D%E6%9D%82%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">前端(upload-client)代码中的复杂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AF%B9%E6%96%87%E4%BB%B6%E5%88%86%E7%89%87"><span class="toc-number">2.2.3.2.1.</span> <span class="toc-text">如何对文件分片</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">2.2.3.2.2.</span> <span class="toc-text">如何控制请求</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%A4%8D%E6%9D%82%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">后端代码中的复杂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%9A%94%E7%A6%BB%E4%B8%8D%E5%90%8C%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.2.3.3.1.</span> <span class="toc-text">如何隔离不同的文件上传?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%88%86%E7%89%87%E4%B8%8D%E9%87%8D%E5%A4%8D"><span class="toc-number">2.2.3.3.2.</span> <span class="toc-text">如何保证分片不重复?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E5%88%86%E7%89%87%E5%88%B0%E5%BA%95%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.3.3.3.</span> <span class="toc-text">合并分片到底做什么?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.3.3.4.</span> <span class="toc-text">实际访问文件</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ABT-%E5%9C%A8%E5%89%8D%E7%AB%AF%E5%9F%BA%E5%BB%BA%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.</span> <span class="toc-text">ABT 在前端基建中的实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-2"><span class="toc-number">3.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%92%8C%E6%96%B9%E6%A1%88-1"><span class="toc-number">3.2.</span> <span class="toc-text">问题和方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8D%8F%E4%BD%9C%EF%BC%9F"><span class="toc-number">3.2.1.</span> <span class="toc-text">如何协作？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%EF%BC%9F"><span class="toc-number">3.2.2.</span> <span class="toc-text">前端如何开发？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">流程和结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%86%E6%B5%81%EF%BC%9F"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">如何分流？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%94%B9%E5%8F%98%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%9F"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">如何改变运行代码？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8E%A8%E5%85%A8%E5%90%8E%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">实验推全后如何处理？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">细节问题？</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/82b65601.html" title="前端渲染方式之SSR渲染"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/wallpaper/1703262863447.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="前端渲染方式之SSR渲染"></a><div class="content"><a class="title" href="/posts/82b65601.html" title="前端渲染方式之SSR渲染">前端渲染方式之SSR渲染</a><time datetime="2024-08-29T15:02:05.000Z" title="发表于 2024-08-29 15:02:05">2024-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/616f4683.html" title="前端性能优化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1700908475489.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="前端性能优化"></a><div class="content"><a class="title" href="/posts/616f4683.html" title="前端性能优化">前端性能优化</a><time datetime="2024-08-27T23:20:29.000Z" title="发表于 2024-08-27 23:20:29">2024-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/262c4a52.html" title="前端工程化配置，工程能力学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1722687861605.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="前端工程化配置，工程能力学习"></a><div class="content"><a class="title" href="/posts/262c4a52.html" title="前端工程化配置，工程能力学习">前端工程化配置，工程能力学习</a><time datetime="2024-08-09T01:07:53.000Z" title="发表于 2024-08-09 01:07:53">2024-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f576a3fe.html" title="记录第一次字节实习offer"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/8c52b9660688cedcc40580545cef9ba4.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="记录第一次字节实习offer"></a><div class="content"><a class="title" href="/posts/f576a3fe.html" title="记录第一次字节实习offer">记录第一次字节实习offer</a><time datetime="2024-07-26T22:56:41.000Z" title="发表于 2024-07-26 22:56:41">2024-07-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8f49bd54.html" title="前端技术探索"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="前端技术探索"></a><div class="content"><a class="title" href="/posts/8f49bd54.html" title="前端技术探索">前端技术探索</a><time datetime="2024-06-23T13:26:24.000Z" title="发表于 2024-06-23 13:26:24">2024-06-23</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div class="copyright">&copy;2023 - 2024 By 月晕</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">34</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">13</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>留言</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/resume/"><i class="anzhiyufont anzhiyu-icon-book faa-tada" style="font-size:.9em"></i><span> 简历</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Clash/" style="font-size:.88rem">Clash<sup>1</sup></a><a href="/tags/Git/" style="font-size:.88rem">Git<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size:.88rem">JavaScript<sup>10</sup></a><a href="/tags/Linux/" style="font-size:.88rem">Linux<sup>2</sup></a><a href="/tags/NestJS/" style="font-size:.88rem">NestJS<sup>1</sup></a><a href="/tags/Nginx/" style="font-size:.88rem">Nginx<sup>1</sup></a><a href="/tags/PM2/" style="font-size:.88rem">PM2<sup>1</sup></a><a href="/tags/Python/" style="font-size:.88rem">Python<sup>1</sup></a><a href="/tags/React/" style="font-size:.88rem">React<sup>4</sup></a><a href="/tags/React-Native/" style="font-size:.88rem">React Native<sup>1</sup></a><a href="/tags/TypeScript/" style="font-size:.88rem">TypeScript<sup>2</sup></a><a href="/tags/Vite/" style="font-size:.88rem">Vite<sup>1</sup></a><a href="/tags/Vue/" style="font-size:.88rem">Vue<sup>2</sup></a><a href="/tags/go/" style="font-size:.88rem">go<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size:.88rem">代理<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size:.88rem;font-weight:500;color:var(--anzhiyu-lighttext)">前端<sup>15</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" style="font-size:.88rem">前端框架<sup>2</sup></a><a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size:.88rem">反向代理<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size:.88rem">后端<sup>2</sup></a><a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size:.88rem">工程化<sup>1</sup></a><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size:.88rem">性能优化<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7/" style="font-size:.88rem">打包工具<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:.88rem">数据结构<sup>1</sup></a><a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/" style="font-size:.88rem">浏览器原理<sup>1</sup></a><a href="/tags/%E6%B8%B2%E6%9F%93/" style="font-size:.88rem">渲染<sup>1</sup></a><a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size:.88rem">源码分析<sup>2</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size:.88rem">爬虫<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:.88rem">算法<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size:.88rem">计算机<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size:.88rem;font-weight:500;color:var(--anzhiyu-lighttext)">计算机基础<sup>3</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:.88rem">计算机操作系统<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">计算机网络<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size:.88rem">面试<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size:.88rem">面试题<sup>1</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://chat.yueyun.site',
      region: 'ap-hangzhou',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.21/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://chat.yueyun.site',
      region: 'ap-hangzhou',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-W3DLGJMJDY', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginModelPath:"assets/",model:{jsonPath:"/live2dw/assets/unitychan.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>