<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>前端项目中的亮点 | 月晕</title><meta name="keywords" content="React,前端框架,前端"><meta name="author" content="月晕"><meta name="copyright" content="月晕"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="前端项目中的亮点"><meta name="application-name" content="前端项目中的亮点"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="前端项目中的亮点"><meta property="og:url" content="https://blog.yueyun.site/posts/72a725a9.html"><meta property="og:site_name" content="月晕"><meta property="og:description" content="本文主要介绍前端项目中的亮点，包括React、JavaScript、TypeScript等。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg"><meta property="article:author" content="月晕"><meta property="article:tag" content="JS,前端,前端开发,TS,TypeScript,Node,Node.js,Nodejs,Node,后端"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg"><meta name="description" content="本文主要介绍前端项目中的亮点，包括React、JavaScript、TypeScript等。"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.yueyun.site/posts/72a725a9"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><meta name="google-site-verification" content="QmqYgcPLCjEZmEbdJVKduTaxnvd3OFJRyp3BLB2f0VQ"><meta name="baidu-site-verification" content="codeva-XPqAkKFOID"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script async src="https://www.googletagmanager.com/gtag/js?id=G-W3DLGJMJDY"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-W3DLGJMJDY")</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"T^T","backTitle":"Ciallo~"},
  LA51: {"enable":true,"ck":"3GbfdCFGvNdWoQg1","LingQueMonitorID":"3GbfdCFGvNdWoQg1"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://chat.yueyun.site',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🖥️ JavaScript爱好者","🔍 前沿技术追随者","🩵 吃饭睡觉看动漫","🔨 前端后端一把梭","🤓 玉玉郁郁第一名","🧟 间歇性发奋图强","😵 持续性混吃等死","🥰 欢迎找我来聊天"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 月晕","link":"链接: ","source":"来源: 月晕","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"月晕",title:"前端项目中的亮点",postAI:"",pageFillDescription:"网络库的封装和实现, 背景, 方案和设计, 库结构的宏观设计, 请求缓存, 请求结果怎么存? 存在那些地方? 缓存键是什么?, 缓存何时失效? 基于时间还是其他条件?, 如何实现?, 请求幂等, 样本代码, 总结如何实现请求库, 大文件上传, 背景, 问题和方案, 如何减少页面阻塞, 前后端如何协调, 创建文件协议, hash校验协议, 分片数据上传协议, 分片合并协议, 代码如何组织, upload-core中的通用函数, 前端(upload-client)代码中的复杂问题, 如何对文件分片, 如何控制请求, 后端代码中的复杂问题, 如何隔离不同的文件上传?, 如何保证分片不重复?, 合并分片到底做什么?, 实际访问文件, 总结如何实现Upload-SDK库, ABT在前端基建中的实践, 背景, 问题和方案, 如何协作？, 前端如何开发？, 流程和结构, 如何分流？, 如何改变运行代码？, 实验推全后如何处理？, 细节问题？, 总结, 首屏优化, 背景, 问题的收集与分析, 措施的制定与实施, 针对HTTP1.1的优化措施, 针对重复代码的优化措施, 如何找到重复？, 何时提重？, 针对无差别加载的优化措施, 针对大量API网络请求的优化措施, 总结网络库的封装和实现背景背景虽然在前端领域有很多成熟的请求库但是在实际的开发过程中很难符合契合实际的开发需求比如经典的库并不具备以下功能请求重试请求缓存请求幂等请求串行请求并发虽然提供的三方功能很多仍然存在与上层框架过度绑定导致开发场景受限无法提供统一的成熟度不很完全不能自己随时开口子改设计没有聚合基础的请求库依然需要手动整合公共库并不包含公司内部制定的协议规范即便使用公共库也需要进行二次封装需要自行封装一套适配公司业务的前端请求库方案和设计库结构的宏观设计整个库结构包含三层从下往上依次是请求实现层提供请求基本功能提供网络上层控制比如请求串行请求并行请求重试请求防重等功能为请求绑定业务功能该层是接入公司内部协议规范和接口文档向外提供业务接口层是对代码逻辑的划分具体实现有很多种每一层是一个包可以使用多包管理每个层是一个项目子文件夹优化设计在请求实现层的实现有多种方式基于原生基于原生这种实现的多样性可能导致这一层的不稳定而是基础层这样会导致向上传递不稳定性为了隔离这种情况我们使用依赖倒置原则彻底将和请求的实现解耦比如下面的示意代码定义接口并不实现本模块的大部分功能都需要使用到创建一个可以重试的请求进一步配置创建一个并发请求进一步配置代码示意使用实现其他方法代码示意这样一来如果实现改变时无须对做改动仅需新增实现并改动依赖即可比如将来如果改为使用来完成请求仅需要做一下改动新增库使用实现其他方法请求缓存请求缓存是指创建一个带有缓存的请求当没有命中缓存时发送请求并缓存结果当有缓存时直接返回缓存请求使用缓存请求使用缓存要实现此功能需要考虑几个核心的问题请求结果怎么存存在那些地方缓存键是什么我们希望用户能够指定缓存方案内存持久化同时也能够指定缓存键为某次请求的配置使用作为缓存键是否开启持久化缓存存储有多种方案不同的方案能够存储的格式不同支持的功能不同使用的不同兼容性不同为了去除这种差异避免将来存储方案变动时对其他代码造成影响需要设计一个稳定的借口来抹除不同方案的差异其他字段缓存何时失效基于时间还是其他条件我们希望用户能够指定缓存如何失效指定缓存时间自定义缓存是否有效提供配置后配置失效表示缓存键表示此次请求配置返回表示缓存有效如何实现核心逻辑参数归一化使用缓存仓库获得请求实例对请求进行配置对请求进行配置注册请求发送前的事件获得缓存键是否存在缓存返回缓存结果获得缓存键请求幂等幂等性是一个数字概念常见于抽象代数无论的值是多少不变为在网络请求中很多接口都要求幂等性比如支付同一订单多次支付和一次支付对用户余额的影响应该是一样的要解决这个问题就必须保证要求幂等的请求不能重复提交这里的关键问题就是定义什么是重复我们可以把重复定义为请求方法请求头请求体完全一致因此我们可以使用将它们编码成一个字符串当请求幂等时直接返回缓存结果即可在实现上可以直接利用缓存功能实现样本代码公司接口数量庞大并且时常变化如果层是全部人工处理不仅耗时而且容易出错可以通过一些标准化的工具让整个过程自动化样版代码的生成我们使用开发了命令行工具用于样本代码的生成接口平台提供了生成标准格式的通过请求即可生成标准的描述文件发布文章其他字段获取文章其他字段生成的样版代码发布文章获取文章通用库的开发从到开发整个请求库以适配项目开发中遇到的所有请求场景包含请求并发串行幂等缓存等同时包含自动化工具用于根据接口文档生成请求样版代码请求库不仅完全消除了不同框架间重复的请求代码极大的缩短了接口的联调时间为业务开发提效同时带来更高的可维护性总结如何实现请求库方案选择首先考虑到实现的必要性前端本身存在诸多的请求库像成熟度比较高的但它们都是一些基础库没有提供上层功能比如请求并发请求重试请求幂等这些都没有另外像一些上层的请求库倒是有这些功能比如但它们都和具体的框架绑定了并且没有提供请求的基础功能而且它们之间使用风格和功能点都有差异更重要的一点是市面上的公共库不可能提供基于公司内部协议的封装所以我不得不考虑重新实现基于公司内部业务的通用请求库技术实现实现层面首先考虑的是请求库的整体设计把请求库分成三层从下到上依次是请求基础库负责发送请求的基本功能然后是请求核心库负责实现各种上层逻辑比如并发请求请求重试等功能最上层是业务请求层负责在代码层面封装公司的内部协议在结构上考虑到请求基础库的具体实现可能会有很多变化比如等为了隔离这种对上层代码造成的改变使用原则让核心库不依赖具体的请求基础库核心库仅提供接口请求基础库可以基于接口提供不同的实现方式在业务库注入具体实现即可这样就能隔离请求的具体实现将来实现变动只需要新增基础的实现接口即可另外上层业务库由于深度绑定公司内部的接口文档而我们项目中的接口数量很庞大为减少开发和维护成本使用实现一个自动化工具通过解析接口标准文档自动为每个接口生成请求样版代码落地效果整个请求库的落地效果还是很亮眼的业务开发人员再也无须关心任何的请求只需调用请求库的业务函数即可无须关心内部的并发幂等这些复杂问题这些事情对业务开发人员完全无感整个请求库为公司的业务开发带来的效率提升并依靠自动生成的样板代码减少了的接口联调的时间大文件上传背景平台中包含企业资料会议视频等大文件的上传如果不做特殊处理将遇到以下的问题网络中断程序异常退出等问题导致文件上传失败而不得不重新上传同一文件被不同用户反复上传白白占用网络和服务器储存资源问题和方案大文件上传的普遍方案是文件分片上传如果把文件上传看做是一个不可分割的事务那么分片的目标就是把一个耗时的大事务划分为一个一个的小事务由于使用层来承接前端的文件请求因此需要开通前后端所有跟文件上传的阻碍分片上传的主要障碍集中在如何减少页面阻塞前后端如何协调代码如何组织前端代码中的复杂逻辑代码中的复杂逻辑如何减少页面阻塞分片上传的一个首要目标就是要尽量避免相同的分片重复上传服务器必须要能够识别来自各个客户端的各个上传请求中是否存在与过去分片相同的上传请求服务器如何识别那些分片是相同的呢首先需要对相同下一个定义文件内容一样即为相同可以对文件内容进行二进制的对比是一个非常耗时的操作于是可以可以选择基于内容的表示对比是一种算法可以将任何长度的数据转化成定长的数据不仅针对分片如此针对整个文件也是如此可见客户端需要承担两件重要的事情对文件进行分片并计算每个分片的值根据所有的值计算整个文件的值而计算是一件密集型的操作如果不加处理将会导致长时间的阻塞主线程一般的做法为了解决这个问题我们可以对大文件上传做一个假设绝大部分的文件上传都是新文件上传有了这个假设我们就无须等待整体的计算结果直接上传分片即可同时可以把分片操作使用多线程异步的方式进行上传处理这样做的好处是页面完全无阻塞也无须等待整体即可启动上传相比于传统方案对于新文件上传可以缩短整体上传时间消除页面的阻塞对于旧文件上传可能会产生一些无效的请求但这些请求仅传递的是并不真实上传文件数据所以对网络和服务器影响很小加上旧文件上传情况相对较少所以整体可以忽略不计前后端如何协调文件上传涉及到前后端的交互需要建立一个标准的通信协议通过协议要能完成下面几件核心交互创建文件校验分片数据上传分片合并创建文件协议当客户端发送分片到服务器需要告知服务器分片属于那一次文件上传因此需要一个唯一标识来标识某一次文件上传创建文件协议就是用于获取文件上传的唯一标识文件上传的唯一标识分片大小单位字节校验协议客户端有时需要校验单个分片或整个文件的服务器需要告知客户端它们目的的具体情况取值或分别代表分片和文件整体分片或文件的具体值指示服务器是否已经存储了对应的分片或文件当校验文件时持有的响应字段指示该文件还剩余那些没有上传当校验文件时持有响应字段如果该文件已经完成上传出现字段表示文件而请求地址分片数据上传协议通过此协议上传具体的文件分片数据分片合并协议当所有的分片全部上传后通过此协议请求服务器完成分片合并代码如何组织大文件上传的搭建分为三层上传协议约定前后端的通信格式基于协议的提供协议字段的创建读取前后端通用工具函数等核心功能应用于客户端的用于的中的通用函数统一前后端涉及到的基于各种事件的处理使用发布订阅模式提供统一的类前端可能出现的各种事件上传进度改变事件上传暂停恢复事件等等后端可能出现的各种事件分片写入完成事件分布合并完成事件等等为了支撑前后端的多任务并发执行提供类前端可能的并发执行并发请求后端可能的并发执行并发的分片校验可并发执行的任务队列待执行的任务当前正在执行的任务数任务状态最大并发数添加任务添加任务并执行启动启动任务当前无任务触发事件设置任务状态为触发事件开始执行下一个任务执行下一个任务如果整体的任务状态不是结束并发已满结束取出第一个任务没有任务了暂停执行执行任务任务执行完成后当前任务数执行下一个任务暂停前端代码中的复杂问题前端涉及到两个核心问题如何对文件分片如何控制请求如何对文件分片首先要实现分片对象的处理分片的二进制数据分片的起始位置分片的结束位置分片的值分片在文件的索引创建一个不带的计算的值接下来要对整个文件进行分片分片的方式有很多如普通分片基于多线程的分片基于主线程时间切片的分片其他分片模式考虑到通用性必须要向上层提供不同的分片模式同时还要允许上层自定义分片模式因此在设计上使用基于抽象类的模板模式来完成处理分片大小单位字节待分片的文件整个文件的分片列表已计算的分片数据计算的工具是否已经分片获取分片数组计算完成分片完成后一些需要销毁的工作基于此抽象类即可实现多种形式的分片模式每种模式只需要继承实现计算分片的即可比如基于多线程的分片类可以非常简单的实现如何控制请求对请求的控制涉及多个方面的问题如何充分利用带宽分片上传中涉及到大量的请求发送这些请求即不能一起发送造成网络阻塞也不能依次发送浪费带宽资源因此需要有请求并发控制的机制方案利用基础库的实现并发控制如何与上层请求库解耦考虑到通用性上层应用可能会使用各种请求库发送请求因此前端不能绑定任何的请求库方案使用策略模式对请求库解耦比如请求策略请求策略文件创建请求返回分片上传请求文件合并请求返回文件校验请求请求控制请求策略没有传递则使用默认策略分片策略没有传递则默认多线程分片任务队列其他属性略初始化获取文件分片事件监听分片事件处理分片上传任务加入队列校验文件已存在分片上传整体事件处理校验文件已存在根据重新编排后续任务后端代码中的复杂问题相对于客户端而言服务器面临着更大的挑战如何隔离不同的文件上传在创建文件协议中服务器使用生成一个不可纂改的唯一编码用于标识不同的文件上传如何保证分片不重复重复的含义是指不保存重复分片不上传重复分片这就要求分片跨文件唯一并且永不删除也就是服务器并不保存合并之后的文件仅记录文件中的分片顺序合并分片到底做什么合并会造成很多问题比如极其耗时需要找到文件并组装数据冗余所以服务器并不发生真正的合并而是在数据库中记录文件中包含的分片因此合并操作时服务器仅做简单的处理校验文件大小校验文件标记文件状态生成文件访问地址上面操作效率很高实际访问文件由于服务器并未发生真正的文件合并当后续请求该文件时服务器需要动态处理具体的做法是服务器收到对文件的请求并在数据库中找到了对应的文件服务器读取文件的所有分片依次找到对应的分片文件服务器利用的并发控制能力逐步产生文件读取流并利用管道直接输出到网络通用库的开发从到开发整个该为所有文件上传特别是大文件上传的场景提供前后端的支撑统一了所有文件上传的开发方式完成了从底层协议工具类前端组件后端中间件的开发在实现层面保证使用的灵活性利用多种设计模式完成了和上层应用的完全解耦对服务器的存储结构进行了精细的设计保证了文件存储和传输的唯一性总结如何实现库方案选择大文件上传的普遍性方案是文件分片文件分片其实就是整体的文件上传的大事务分成一个一个分片上传的小事务从而降低失败的风险整个大文件上传的实现会涉及到很多的技术细节比如底层协议标准如何制定协议标准决定了前后端如何交互也就决定了前后端代码如何开发除了协议之外还涉及到前端如何进行并发控制如何高效的分片以及涉及到后端如何存储分片如何高效合并分片如何保证分片的唯一性等等等等市面上没有形成统一的解决方案虽然公有云上的有各自的实现方案但考虑到我们的产品可能会部署到客户的私有云上所以最稳妥的办法还是自行实现整个大文件上传技术实现首先设计的是整体上传流程传统的大文件都是在客户端先完成所有的分片然后计算每个分片和完整的文件在使用和服务器换取当前文件的信息由于的计算是密集型的操作这样一来会导致长时间的客户端阻塞虽然可以使用来加速的计算但经过测试即便是使用了多线程某些超大文件比如上了个的文件在配置不太好的客户机上计算时长可以超过秒这是无法接受的因此对上传流程进行了优化假定大部分文件上传都是一个新文件上传于是在流程上允许用户在获得文件完整之前直接上传分片这样几乎可以做到零延时的上传等到文件整体计算来后在向服务器补充数据基于这样的流程于是设计了一套标准化的文件上传协议协议主要包含四个通信标准创建文件协议前端使用请求向服务器提交文件基本信息换取上传唯一后续的请求必须携带此校验协议前端把某个分片或者是整个文件发送给服务器得到分片和文件的状态信息分片上传协议前端将分片的二进制数据发送到服务器存储分片合并协议前端提示服务器可以完成分片合并了设计好协议后接下来就需要落实到代码的实现上在前端部分主要问题集中在与如何分片和如何控制请求流程首先是如何分片考虑到不同的场景可能选择不同的分片模式比如多线程分片比如基于时间切片类似于的分片甚至是由上层应用自行定义的分片模式于是在实现分片逻辑时我使用了模版模式利用的抽象类定义好分片的整体流程具体的子类仅需实现分片计算即可这样一来就可以保持极高的灵活度在请求流程控制层面由于有诸多请求需要发送因此我开发了一套并发请求控制类以充分的利用网络带宽另外由于请求过程中需要向上层抛出各种钩子比如进度的变化请求状态的变化等等对这一块我使用了发布订阅模式编写了通用的类这样可以在请求过程中抛出各种事件上层应用通过监听事件完成处理当然整个系统复杂度最高的还是在后端由于这个项目有层需要在层完成文件处理因此还需要针对服务器编写相应代码服务器最大的挑战就是如何保证每个分片的唯一性这种唯一性即包含存储的唯一性也包含传输的唯一性存储的唯一性保证了分片不会重复保存避免了数据的冗余传输的唯一性保证了分片不会重复上传避免了通信的冗余要保证分片不会重复保存就必须让分片和文件解耦分片是分片文件是文件分片独立保存不从属于任何文件文件独立记录按照顺序依次指向不同分片这样一来哪怕出现两个不同文件拥有相同分片的场景也不会在服务器出现重复存储的问题因为分片是独立于文件的而要保证分片不会重复上传就必须保证分片永不删除如果在合并文件后删除了分片就会导致下一次有相同分片上传时服务器找不到对应的分片文件就必须重复上传因此分片永不删除最后就是合并分片的逻辑我考虑到如果真正的把分片文件合并成一个大文件大文件的所有数据实际上都是冗余的而且整个合并过程极其耗时因此我做了这样的处理当收到合并请求时服务器其实仅仅做一些简单的校验即可比如文件大小分片数量等校验而不进行真正的合并仅在数据库中更新该文件的状态并生成文件访问的地址即可等到用户真正访问文件时我根据数据库中对应文件的分片记录使用文件流依次读取分片数据用流管道直接响应给客户端即可这样一来整个合并效率和文件访问效率都极高同时服务器的存储不会有任何冗余在前端基建中的实践背景产品有时无法确定哪种设计方案更好因此希望前端能够同时上线多个产品方案根据某套规则将用户导流到不同的方案在用户体验理论研究中这种做法称之为后续简称一次实验会生成至少两套方案对照组实验组并且可以允许多个实验共存实验会涉及多个岗位的协调包含前端后端测试运维产品其中起主要作用的是产品和前端问题和方案为前端带来诸多的挑战其中包括如何协作在一个实验生命周期内涉及到哪些角色角色之间是如何协作的前端如何开发实验具有以下几个特点多个实验共存产品可能会先后发起几十个甚至上百个实验不同的实验有不同的分流规则每个实验又有多个对照组实验是精确到组件的一个实验对应到多个前端组件一个组件不同的对照组之间的差异是灵活的实验是频繁的用户参与实验必须是无感的实验推全后只保留一个对照组流程和结构运作流程的结构整个包含了诸多和工具为应用开发提供支撑其中提供最底层的核心功能比如实验信息分流控制代码剪枝数据决策等等针对服务器提供一些中间件针对前端两种框架提供一些组件仓库路由等针对前端两种常见构建工具提供一些插件集成比如工具插件命令行工具等等如何分流使用存储当前每个实验不同对照组的参与人数使用浏览器指纹用户身份保证同一用户对同一实验仅参与一个组两种做法将指纹用户身份组打包成发送给客户端不精准成本低使用数据库保存映射关系精准成本高按照规则中的分流比例为新用户分配组别将所有实验的以及每个组别的编号下发到客户端如何改变运行代码实验和组别对运行时的影响主要是渲染组件的不同但也有可能对其他代码造成影响由于每次实验所产生的差异是极其灵活的因此难以使用一种标准化的静态格式来描述差异这就不可避免的造成了对业务代码的侵入基建的一个重要目标就是要将这种侵入最小化标准化提供高阶组件屏蔽组件差异示例示例提供高阶函数屏蔽差异使用自定义指令屏蔽差异利用自定义的插件会将上面的代码转换为与此同时我们也改变了默认情况下开启后上面的代码会被转换为下面的我们对此作了改变将代码变成了实验推全后如何处理当产品完成实验后会选定一种方案进行推全此时会涉及到对应实验的代码如何剪枝的问题由于实验并不向外界暴露当前用户所处的实验分组因此业务开发者要根据不同分组进行不同处理的代码逻辑必须使用实验才能完成这就对自动化的实验推全提供了基础由于所有的实验代码都是使用完成的因此可以通过一个简洁的逻辑即可完成自动化实验推全实验为各种构建工具提供插件打包时插件会通过代码分析找出当前哪些文件对应到哪些实验插件会对照最新的实验信息找到已经被推全的实验插件定位到所有与该实验有关的源码文件插件提示开发者是否对已推全的实验进行剪枝开发者确认后插件自动修改完成剪枝通过完成剪枝逻辑是非常容易的比如针对组件的剪枝剪枝前剪枝后假设将推全细节问题白屏问题对于一个应用它的组件渲染取决于所处的组别而它所属哪个组别又必须通过网络通信才能确定这就导致了首屏渲染的白屏问题而我们观察到整个应用中实际上只有部分组件会参与到实验对于没有参与到实验的组件是不需要等待分组信息的因此我们将参与到实验的组件制作为异步组件从而可以不影响其他组件的渲染代码检查问题由于实验推全时需要对代码进行剪枝剪枝发生在编译时态它通过检查代码中包含的代码完成而大部分中的都需要绑定实验名称例如如果实验名称来自于一个变量或表达式或者其他需要在运行时才能确定的值这就会导致剪枝失败因此我们制作了插件来约束开发者必须使用字面量或者其他在编译时态能确定的值开发规范不会暴露用户的分组信息给开发者这主要是考虑到开发者可能写出下面的代码用户的分组代码用户的分组代码这样的代码无法被代码剪枝工具察觉容易在实验推全后仍然保留在代码中虽然功能性不受影响但会逐步降低代码的可维护性以上是不暴露的主要原因但开发者仍然有可能间接的获取到用户的分组比如代码代码这种代码很难通过自动化工具检查处理因此需要通过开发规范来约束所有跟实验相关的处理必须通过完成项目介绍是一套为实验提供技术支撑的开发工具包它分为底层的以及上层的可以集成到框架工程整个的开发使用到了诸多前端技术包括但不仅限于自定义插件分析浏览器指纹高阶组件脚手架开发项目职责参与工具链的开发和集成参与规范和协作流程的制定参与和前端框架的集成其他技术难点攻坚项目亮点从到开发整个为产品制定实验提供技术支撑可作用于等前端常见的技术场景为实验开发提供全流程支撑整套不仅中止了实验业务开发的混乱局面为前端实验业务的开发提效减少的代码出错几率同时大幅提升代码质量总结请介绍你开发的背景这套是为支撑实验研发的属于是我们前端基建的一部分之所以要开发这套是因为在没有它之前要走完一次实验的流程成本是非常高的后来经过我的调研和分析造成这种高成本的根本原因就是缺乏标准化具体来说体现在几个方面没有标准化的流程管理成本举例实验冲突问题没有标准化的工具维护成本举例实验推全时代码剪枝问题没有标准化的开发成本举例实验全面侵入业务代码心智负担过重方案选择所以解决方案是非常明确的就是标准化但如何标准化目前前端领域没有一个统一且成熟的答案之所以没有是因为实验是深度绑定业务的而业务的差异化导致难以在技术领域形成标准可以把每次实验的每个组别都当作是产品提出的一次业务需求这种需求是极其灵活的因此难以形成技术领域的标准虽然难以形成技术领域的标准但形成公司内部的标准却是可行的当然这种标准是多方面的我这里单从技术的角度聊一聊的标准化标准化的重要目标就是要把前端代码当中所有跟实验相关的代码从语义的角度进行隔离举例逻辑判断举例高阶组件这种隔离不仅可以提升开发效率而且对将来的实验推全奠定了自动化的基础当然只是整套的一部分因为我们的前端代码是散落在不同技术位置的比如服务器搭建的以为主的活动页面搭建的多页应用搭建的组件库等等等等要适配多种技术场景我们把分为了底层和上层底层提供核心上层调用底层的产生多个库适配不同的技术场景见简历总之整套就是保证无论是哪种技术场景都能够在其中找到合适的工具比如自动化的实验推全中有相应的命令行工具也可以使用它的插件或者插件在打包时自动推全比如实验分流中有相应的工具会根据用户身份和浏览器指纹以及分流规则实验状态等信息共同决定用户应该处于哪个实验分组再比如对于代码中有相应的插件可以识别我们自定义的指令这些指令是我们单独为实验定制的因此需要开发自定义的插件来解析最终效果总之有了这套后有过统计在实验的开发效率上提升了并且减少了的代码出错几率同时在代码可读性可维护性上都有大幅度提升首屏优化背景公司的产品面向的是企业用户大部分企业用户会选择对产品进行私有化部署企业对产品的需求是差异化的因此公司研发了一套低码平台方便客户对产品进行差异化定制客户通过低码平台的定制会产生文件这些文件会在运行时加载大量客户反馈首屏等待时间过长的问题需要制定针对性的优化策略解决问题而要针对性的优化必须要先弄清楚目前的性能热点在哪里因此我们将整个优化过程分为三步问题的收集与分析措施的制定与实施方案的部署与反馈以上三步可反复轮询直到问题解决问题的收集与分析这一步的目标是要准确的找到客户侧的问题究竟在哪找不到问题就无法针对性的制定优化措施而要找到问题并不容易根据过往经验大系统的优化问题定位往往需要几个环节的反复进行可是问题发生在客户侧而客户侧的系统不直接暴露到公网因此收集问题的环节就非常麻烦因此我们搭建了一套客户侧数据上报的流程让客户可以安全的把性能数据推送到我们的数据中心制定这套流程的初衷不仅是为了方便收集目前特定用户的性能问题更重要的是可以收集任何客户反馈的任何问题要落实这一系列流程需要在技术面提供多方面的支持服务监控系统的更改前端后端数据脱敏大数据数据展示前端问题实验室前端最终经过几轮测试问题被清晰的定位协议效率低下的问题队头阻塞头部臃肿大量的代码重复大量代码无差别加载大量的网络请求措施的制定与实施针对的优化措施队头阻塞问题针对这一问题没有别的办法只能多开域名来解决浏览器针对同一域名可以支持最多个并发连接超越这个数字后将发生队头阻塞头部臃肿由于不支持头部压缩而发送的请求中包含大量的自定义头部于是我们借鉴了的头部压缩方式对自定义头部进行了压缩处理针对重复代码的优化措施客户侧会产生巨量的差异化文件每个文件的产生逻辑非常简单结果就是客户侧保存了大量代码文件并且代码文件中出现了大量重复代码其他差异配置代码段其他差异代码段代码段其他差异代码段其他差异配置代码段其他差异代码段代码段其他差异代码段比较容易想到的解决办法是把那些有可能出现差异的代码提取到公共代码中这种方案除了逻辑简单根本无法实施主要原因是很难知道客户侧会产生哪些重复代码如果把所有可能都枚举到公共代码中会产生大量的无效代码因此对重复代码的提取必须动态完成这里面有两个关键问题如何找到代码中的重复何时提重如何找到重复考虑下面两段代码如何找到重复代码片段代码片段通过分析可以得到两棵树我们的目标是找出两棵树连续的相同结构的节点将它们提取成函数同时把相同结构中的不同点提取为函数参数大致思路是计算每个节点的结构变量声明节点的求值省略其他代码变量名初始值类型字面量表达式变量得到将树信息入库含结果库中的信息大致如下寻找库中出现的连续的一致的节点进行提重将差异点提取为参数最终提重的结果如下自动提重后的代码然后代码片段被修改为代码片段代码片段何时提重为了保证效率提重可以异步延时执行也可以开启计划任务在服务器空闲时执行也可以管理员手动执行针对无差别加载的优化措施过去用户侧自定义产生的差异都是在首屏全部加载的实际上很多并不需要在当前页面运行因此需要对这些进行差别化加载视口内需要的先加载不需要的延迟加载这就需要做到两件事定义每个功能页视口内组件标识每个文件对应到哪个组件已有功能此时很容易完成不再详细阐述针对大量网络请求的优化措施大量的首屏请求均来自自动化生成的差异代码其中包含大量的重复请求我们针对性的加入了短时缓存让相同的请求走缓存通道自动生成的代码修改为无缓存初始化按参数查找缓存无缓存初始化项目亮点针对客户反馈的首屏慢问题制定了详细的优化策略并完整参与了优化措施的落地通过数据埋点收集和定位性能问题通过本地实验室复现问题针对问题制定了具体的优化措施包括解决了的队头阻塞和头部无压缩的问题以及开发了自动化工具完成自动代码提重从而压缩包体积等诸多手段经过优化后的代码时间降低了同时提供了一套完整标准的工单流程总结请讲讲你是如何首屏优化的策略的制定无论是做哪一种优化都需要经过三个步骤定位问题解决问题测试反馈很多时候都是在这三个步骤间反复轮询而我们项目的难点在于我们的产品很多是私有化部署并且用户可以通过低码平台实现产品的高度定制也就是说我们无法知晓客户定制了哪些内容由定制产生了多少文件无法复现客户的运行环境无法复现客户的问题所以我首先是制定了一套完整的工单申报流程为每个客户提出的问题发起工单然后在本地开启工单的代码分支在分支里面针对性的加入埋点代码然后推送代码给用户用户一端收集的信息经过数据脱敏后上报到我们的数据中心我这边根据数据最终定位问题下面我挑一两个问题说吧技术实现我们当时遇到的一个比较大的问题是的效率问题因为我们的客户有些浏览器是不支持的而首屏加载的资源量数量非常多受我们架构的影响又很难合并它们所以会遇到的队头阻塞和头部压缩的问题针对队头阻塞我使用了多域名的方式解决这是常规手段没多少可说的而头部压缩这一块我是借鉴了的做法在客户端和服务器分别建立静态表和动态表把所有的自定义头部压缩成了一个压缩比最高可以达到这是非常惊人的另外除了网络这一块还遇到一个比较棘手的问题就是重复代码客户那边很多代码是他们通过低码平台自动生成的有些定制度比较高的客户可能生成了好几百个这些文件中存在大量重复的代码从而增加了整体的传输体积所以我开发了一套任务它可以自动嗅探到多个文件中的重复代码并把他们提取到一个公共中形成一个一个的函数把差异化的地方自动提取为参数然后自动修改原始文件的相应位置把它们变成一个一个的函数调用这件事说起来简单实际开发起来其实是非常复杂的它涉及到抽象语法树分析树结构对比从而发现重复和提取重复运算和数据库存储等一系列的事情因为这件事是在层完成的所以也是由我们前端处理的其他的优化还有很多有些简单有些麻烦但最棘手我印象最深的就是上面两点",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-06-24 11:07:49",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W3DLGJMJDY"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-W3DLGJMJDY")</script><meta name="generator" content="Hexo 7.0.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/yueyun.jpg"><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">月晕</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>留言</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div class="nav-change" id="nav-darkmode"><a class="darkmode_switchbutton" title="显示模式切换" onclick="darkmo" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><input id="center-console" type="checkbox"><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url">前端</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/JavaScript/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>JavaScript</span></a><a class="article-meta__tags" href="/tags/React/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>React</span></a><a class="article-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>前端</span></a><a class="article-meta__tags" href="/tags/TypeScript/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>TypeScript</span></a></span></div></div><h1 class="post-title" itemprop="name headline">前端项目中的亮点</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="post-meta-icon anzhiyufont anzhiyu-icon-calendar-days"></i><span class="post-meta-label">发表于</span><time itemprop="dateCreated datePublished" datetime="2024-06-23T13:26:24.000Z" title="发表于 2024-06-23 13:26:24">2024-06-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">13.9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为杭州"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>杭州</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/72a725a9.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.yueyun.site/posts/72a725a9.html"><header><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url">前端</a><a href="/tags/JavaScript/" tabindex="-1" itemprop="url">JavaScript</a><a href="/tags/React/" tabindex="-1" itemprop="url">React</a><a href="/tags/%E5%89%8D%E7%AB%AF/" tabindex="-1" itemprop="url">前端</a><a href="/tags/TypeScript/" tabindex="-1" itemprop="url">TypeScript</a><h1 id="CrawlerTitle" itemprop="name headline">前端项目中的亮点</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">月晕</span><time itemprop="dateCreated datePublished" datetime="2024-06-23T13:26:24.000Z" title="undefined 2024-06-23 13:26:24">2024-06-23</time></header><h1 id="网络库的封装和实现"><a href="#网络库的封装和实现" class="headerlink" title="网络库的封装和实现"></a>网络库的封装和实现</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote><p>背景: 虽然在前端领域有很多成熟的请求库, 但是在实际的开发过程中, 很难符合契合实际的开发需求</p></blockquote><p>比如经典的库: <strong>axios</strong> 并不具备以下功能</p><ul><li>请求重试</li><li>请求缓存</li><li>请求幂等</li><li>请求串行</li><li>请求并发</li><li>…</li></ul><p><strong>SWR &#x2F; VueRequest</strong> 虽然提供的三方功能很多, 仍然存在</p><ul><li>与上层框架过度绑定导致开发场景受限, 无法提供统一的API</li><li>成熟度不很完全(?) 不能自己随时开口子改设计</li><li>没有聚合基础的请求库, 依然需要手动整合</li><li>公共库并不包含公司内部制定的协议规范, 即便使用公共库,也需要进行二次封装</li></ul><p><strong>需要自行封装一套适配公司业务的前端请求库</strong></p><h2 id="方案和设计"><a href="#方案和设计" class="headerlink" title="方案和设计"></a>方案和设计</h2><h3 id="库结构的宏观设计"><a href="#库结构的宏观设计" class="headerlink" title="库结构的宏观设计"></a>库结构的宏观设计</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/1.png"></p><p>整个库结构包含三层, 从下往上依次是:</p><ul><li>请求实现层: 提供请求基本功能</li><li>request-core: 提供网络上层控制, 比如请求串行, 请求并行, 请求重试, 请求防重等功能</li><li>request-bus: 为请求绑定业务功能, 该层是接入公司内部协议规范和接口文档, 向外提供业务接口API</li></ul><blockquote><p>层是对代码逻辑的划分,具体实现有很多种</p><ul><li>每一层是一个包, 可以使用多包管理(momorepo)</li><li>每个层是一个项目子文件夹</li><li>…..</li></ul></blockquote><p><strong>优化设计</strong></p><p>在请求实现层的实现有多种方式</p><ul><li>基于XHR原生 || 基于fetch原生</li></ul><p>这种实现的多样性可能导致这一层的不稳定, 而request-imp是基础层, 这样会导致向上传递不稳定性,为了隔离这种情况<br>我们使用DIP(Dependence Inversion Principle 依赖倒置原则) 彻底将 request-core和请求的实现解耦</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/2.png"></p><p>比如下面的示意代码</p><p>request-core</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义接口 并不实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Requestor</span> &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="attr">url</span>:<span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">RequestOptions</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Response</span>&gt;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 本模块的大部分功能都需要使用到Requestor</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">req</span>: <span class="title class_">Requestor</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params">requestor:Requestor</span>) &#123;</span><br><span class="line">    req = requestor</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useRequestor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个可以重试的请求</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRetryRequestor</span>(<span class="params">maxCount = <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> req = <span class="title function_">useRequestor</span>()</span><br><span class="line">    <span class="comment">// 进一步配置</span></span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个并发请求</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createParallelRequestor</span>(<span class="params">maxCount = <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> req = <span class="title function_">useRequestor</span>()</span><br><span class="line">    <span class="comment">// 进一步配置</span></span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>request-axios-imp 代码示意</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Requestor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ins = axios.<span class="title function_">create</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="attr">requestor</span>:<span class="title class_">Requestor</span> = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url,options</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用axios实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>request-bus 代码示意</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;requestor&#125; <span class="keyword">from</span> <span class="string">&#x27;request-axios-imp&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;inject&#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"><span class="title function_">inject</span>(requestor)</span><br></pre></td></tr></table></figure><p>这样一来, 如果实现改变时, 无须对reques-core做改动, 仅需新增实现并改动依赖即可</p><p>比如, 将来如果改为使用fetch api来完成请求, 仅需要做一下改动</p><p>新增库 request-fetch-imp</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Requestor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ins = axios.<span class="title function_">create</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="attr">requestor</span>:<span class="title class_">Requestor</span> = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url,options</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用fetch实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h3><p>请求缓存是指创建一个带有缓存的请求, 当没有命中缓存时发送请求并缓存结果,当有缓存时直接返回缓存</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> req = <span class="title function_">createCacheRequest</span>()</span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/a&#x27;</span>) <span class="comment">// 请求</span></span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/a&#x27;</span>) <span class="comment">// 使用缓存</span></span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/b&#x27;</span>) <span class="comment">// 请求</span></span><br><span class="line">req.<span class="title function_">get</span>(<span class="string">&#x27;/b&#x27;</span>) <span class="comment">// 使用缓存</span></span><br></pre></td></tr></table></figure><p>要实现此功能需要考虑几个核心的问题</p><h4 id="请求结果怎么存-存在那些地方-缓存键是什么"><a href="#请求结果怎么存-存在那些地方-缓存键是什么" class="headerlink" title="请求结果怎么存? 存在那些地方? 缓存键是什么?"></a><strong>请求结果怎么存? 存在那些地方? 缓存键是什么?</strong></h4><p>我们希望用户能够指定缓存方案(内存&#x2F;持久化), 同时也能够指定缓存键</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> req = <span class="title function_">createCacheRequestor</span>(&#123;</span><br><span class="line">    <span class="attr">key</span>: (config) &#123;</span><br><span class="line">    	<span class="comment">// config 为某次请求的配置</span></span><br><span class="line">    	<span class="keyword">return</span> config.<span class="property">pathname</span> <span class="comment">// 使用pathname作为缓存键</span></span><br><span class="line">	&#125;,</span><br><span class="line">    <span class="attr">persist</span>: <span class="literal">true</span> <span class="comment">// 是否开启持久化缓存</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>存储有多种方案, 不同的方案能够存储的格式不同, 支持的功能不同, 使用的API不同, 兼容性不同</p><p>为了去除这种差异, 避免将来存储方案变动时对其他代码造成影响, 需要设计一个稳定的借口来抹除不同方案的差异<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/3.png"></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CacheStore</span> &#123;</span><br><span class="line">    <span class="title function_">has</span>(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;;</span><br><span class="line">    set&lt;T&gt;(<span class="attr">key</span>: <span class="built_in">string</span>, ...<span class="attr">values</span>: T[]): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line">    get&lt;T&gt;(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line">    <span class="comment">// 其他字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useCacheStore</span> (isPersist):<span class="title class_">CacheStore</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isPersist) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">createMemoryStore</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">createStorage</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="缓存何时失效-基于时间还是其他条件"><a href="#缓存何时失效-基于时间还是其他条件" class="headerlink" title="缓存何时失效? 基于时间还是其他条件?"></a>缓存何时失效? 基于时间还是其他条件?</h4><p>我们希望用户能够指定缓存如何失效</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> req = <span class="title function_">createCacheRequestor</span>(&#123;</span><br><span class="line">    <span class="attr">duration</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> <span class="comment">//指定缓存时间</span></span><br><span class="line">    isValid (key, config)&#123;</span><br><span class="line">    	<span class="comment">// 自定义缓存是否有效,提供配置后,duration配置失效</span></span><br><span class="line">    	<span class="comment">// key表示缓存键, config表示此次请求配置</span></span><br><span class="line">    	<span class="comment">// 返回true表示缓存有效</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现?"></a><strong>如何实现?</strong></h4><p>核心逻辑</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCacheRequestor</span>(<span class="params">cacheOptions</span>) &#123;</span><br><span class="line">    <span class="comment">// 参数归一化</span></span><br><span class="line">    <span class="keyword">const</span> options = <span class="title function_">normalizeOptions</span>(cacheOptions)</span><br><span class="line">    <span class="comment">// 使用缓存仓库</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useCacheSotre</span>(options.<span class="property">persist</span>)</span><br><span class="line">    <span class="comment">// 获得请求实例</span></span><br><span class="line">    <span class="keyword">const</span> req = <span class="title function_">useRequestor</span>()</span><br><span class="line">    <span class="comment">// 对请求进行配置</span></span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对请求进行配置</span></span><br><span class="line"><span class="comment">// 注册请求发送前的事件</span></span><br><span class="line">req.<span class="title function_">on</span>(<span class="string">&#x27;beforeRequest&#x27;</span>,<span class="keyword">async</span> (config) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> key = option.<span class="title function_">key</span>(config) <span class="comment">// 获得缓存键</span></span><br><span class="line">    <span class="keyword">const</span> hashKey = <span class="keyword">await</span> store.<span class="title function_">has</span>(key) <span class="comment">// 是否存在缓存</span></span><br><span class="line">    <span class="keyword">if</span>(hashKey &amp;&amp; option.<span class="title function_">isValid</span>(key,config)) &#123;</span><br><span class="line">        <span class="comment">// 返回缓存结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">req.<span class="title function_">on</span>(<span class="string">&#x27;responseBody&#x27;</span>, <span class="function">(<span class="params">config, resp</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = options.<span class="title function_">key</span>(config) <span class="comment">// 获得缓存键</span></span><br><span class="line">    store.<span class="title function_">set</span>(key,resp.<span class="title function_">toPlain</span>())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="请求幂等"><a href="#请求幂等" class="headerlink" title="请求幂等"></a>请求幂等</h3><p>幂等性是一个数字概念, 常见于抽象代数 f(n) &#x3D; 1 ^ n 无论n的值是多少, f(n)不变为1<br>在网络请求中, 很多接口都要求幂等性, 比如支付, 同一订单多次支付和一次支付对用户余额的影响应该是一样的</p><p>要解决这个问题就必须保证: <strong>要求幂等的请求不能重复提交</strong></p><p>这里的关键问题就是定义什么是<strong>重复</strong>?</p><p>我们可以把<strong>重复</strong>定义为: 请求方法, 请求头, 请求体完全一致</p><p>因此我们可以使用<strong>hash</strong>将它们编码成一个字符串</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genKey</span>(<span class="params">req</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>()</span><br><span class="line">    spark.<span class="title function_">append</span>(req.<span class="property">url</span>)</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> [key,value] <span class="keyword">of</span> req.<span class="property">headers</span>) &#123;</span><br><span class="line">        spark.<span class="title function_">append</span>(key)</span><br><span class="line">        spark.<span class="title function_">append</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">    spark.<span class="title function_">append</span>(req.<span class="property">body</span>)</span><br><span class="line">    <span class="keyword">return</span> spark.<span class="title function_">end</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当请求幂等时, 直接返回缓存结果即可<br>在实现上, 可以直接利用缓存功能实现</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createIdempotentRequestor</span>(<span class="params">genKey</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createCacheRequestor</span>(&#123;</span><br><span class="line">        <span class="attr">key</span>: <span class="function">(<span class="params">config</span>) =&gt;</span> genKey &gt; <span class="title function_">genKey</span>(config) : <span class="title function_">hashRequest</span>(config),</span><br><span class="line">    	<span class="attr">persist</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="样本代码"><a href="#样本代码" class="headerlink" title="样本代码"></a>样本代码</h3><p>公司API接口数量庞大并且时常变化, 如果request-bus层是全部人工处理不仅耗时, 而且容易出错, 可以通过一些标准化的工具让整个过程自动化</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/4.png"></p><p><strong>样版代码的生成</strong></p><p>我们使用node开发了命令行工具 <code>request-template-cli</code> 用于样本代码的生成<br>接口平台提供了生成标准格式的API，通过请求API即可生成标准的JSON描述文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;article&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;publishArticle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/article&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;发布文章&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;POST&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;idempotent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pager&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 其他字段</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;getArticles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/article&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取文章&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;idempotent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pager&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 其他字段</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>生成的样版代码</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request-bus/templet/article.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; createIdempotentRequest &#125; <span class="keyword">from</span> <span class="string">&#x27;request-core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发布文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publishArticle = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> req = <span class="title function_">createIdempotentRequest</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (<span class="attr">article</span>: <span class="title class_">Article</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> req.<span class="title function_">post</span>(<span class="string">&#x27;/api/article&#x27;</span>, article).<span class="title function_">then</span>(<span class="function"><span class="params">resp</span>=&gt;</span>resp.<span class="title function_">json</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getArticles = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (<span class="attr">page</span>: <span class="built_in">number</span>, <span class="attr">size</span>: <span class="built_in">number</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> req.<span class="title function_">get</span>(<span class="string">&#x27;/api/article&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">params</span>:&#123;</span><br><span class="line">        page,</span><br><span class="line">        size</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">resp</span>=&gt;</span>resp.<span class="title function_">json</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>通用库的开发</p><ul><li>从0到1开发整个请求库, 以适配项目开发中遇到的所有请求场景, 包含请求并发, 串行, 幂等, 缓存等. 同时包含自动化工具, 用于根据接口文档生成请求样版代码</li><li>请求库不仅完全消除了不同框架间重复的请求代码, 极大的缩短了接口的联调时间, 为业务开发提效30%, 同时带来更高的可维护性</li></ul><h2 id="总结如何实现请求库"><a href="#总结如何实现请求库" class="headerlink" title="总结如何实现请求库"></a>总结如何实现请求库</h2><blockquote><p>方案选择</p></blockquote><p>首先考虑到实现的必要性<br>前端本身存在诸多的请求库，像成熟度比较高的axios，但它们都是一些基础库，没有提供上层功能，比如请求并发、请求重试、请求幂等这些都没有。</p><p>另外像一些上层的请求库倒是有这些功能，比如VueRequest，SWR，但它们都和具体的框架绑定了，并且没有提供请求的基础功能，而且它们之间使用风格和功能点都有差异。</p><p>更重要的一点是，市面上的公共库不可能提供基于公司内部协议的封装。</p><p>所以我不得不考虑重新实现基于公司内部业务的通用请求库。</p><blockquote><p>技术实现</p></blockquote><p>实现层面, 首先考虑的是请求库的整体设计<br>把请求库分成三层, 从下到上依次是: 请求基础库, 负责发送请求的基本功能, 然后是请求核心库, 负责实现各种上层逻辑, 比如并发请求, 请求重试等功能, 最上层是业务请求层, 负责在代码层面封装公司的内部协议</p><p>在结构上, 考虑到请求基础库的具体实现可能会有很多变化(比如 xhr&#x2F;fetch&#x2F;axios&#x2F;umi-request) 等,为了隔离这种对上层代码造成的改变,使用DIP原则, 让核心库不依赖具体的请求基础库, 核心库仅提供TS接口, 请求基础库可以基于接口提供不同的实现方式, 在业务库注入具体实现即可, 这样就能隔离请求的具体实现, 将来实现变动只需要新增基础的实现接口即可</p><p>另外, 上层业务库由于深度绑定公司内部的接口文档, 而我们项目中的接口数量很庞大,为减少开发和维护成本, 使用node实现一个自动化工具,通过解析接口标准文档(swagger),自动为每个接口生成请求样版代码</p><blockquote><p>落地效果</p></blockquote><p>整个请求库的落地效果还是很亮眼的，业务开发人员再也无须关心任何的请求，只需调用请求库的业务函数即可，无须关心内部的并发、幂等这些复杂问题，这些事情对业务开发人员完全无感。</p><p>整个请求库为公司的业务开发带来30%的效率提升，并依靠自动生成的样板代码，减少了50%的接口联调的时间。</p><h1 id="大文件上传"><a href="#大文件上传" class="headerlink" title="大文件上传"></a>大文件上传</h1><h2 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h2><blockquote><p>Saas平台中包含企业资料, 会议视频等大文件的上传, 如果不做特殊处理将遇到以下的问题</p><ol><li>网络中断, 程序异常退出等问题导致文件上传失败, 而不得不重新上传</li><li>同一文件被不同用户反复上传, 白白占用网络和服务器储存资源</li></ol></blockquote><h2 id="问题和方案"><a href="#问题和方案" class="headerlink" title="问题和方案"></a>问题和方案</h2><p>大文件上传的普遍方案是文件分片上传</p><p>如果把文件上传看做是一个不可分割的事务, 那么分片的目标就是把一个耗时的大事务划分为一个一个的小事务</p><p>由于使用BFF层来承接前端的文件请求, 因此需要开通前后端所有跟文件上传的阻碍</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/5.png"></p><p>分片上传的主要障碍集中在</p><ul><li>如何减少页面阻塞</li><li>前后端如何协调</li><li>代码如何组织</li><li>前端代码中的复杂逻辑</li><li>BFF代码中的复杂逻辑</li></ul><h3 id="如何减少页面阻塞"><a href="#如何减少页面阻塞" class="headerlink" title="如何减少页面阻塞"></a>如何减少页面阻塞</h3><p>分片上传的一个首要目标就是要尽量避免相同的分片重复上传. 服务器必须要能够识别来自各个客户端的各个上传请求中, 是否存在与过去分片相同的上传请求</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/6.png"></p><p>服务器如何识别那些分片是相同的呢?</p><p>首先需要对相同下一个定义: 文件内容一样即为相同<br>可以对文件内容进行二进制的对比是一个非常耗时的操作, 于是可以可以选择基于内容的<code>hash</code>表示对比</p><blockquote><p>hash是一种算法, 可以将任何长度的数据转化成定长的数据</p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/7.png"></p><p>不仅针对分片如此, 针对整个文件也是如此<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/8.png"></p><p>可见, 客户端需要承担两件重要的事情:</p><ol><li>对文件进行分片. 并计算每个分片的hash值</li><li>根据所有的hash值, 计算整个文件的hash值</li></ol><p>而计算Hash是一件CPU密集型的操作, 如果不加处理将会导致长时间的阻塞主线程</p><p>一般的做法</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/9.png"></p><p>为了解决这个问题, 我们可以对大文件上传做一个假设: 绝大部分的文件上传都是新文件上传</p><p>有了这个假设, 我们就无须等待整体hash的计算结果, 直接上传分片即可, 同时可以把分片操作使用多线程+异步的方式进行上传处理<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/10.png"></p><p>这样做的好处是: 页面完全无阻塞, 也无须等待整体hash即可启动上传, 相比于传统方案</p><ol><li>对于新文件上传可以缩短整体上传时间, 消除页面的阻塞</li><li>对于旧文件上传可能会产生一些无效的请求, 但这些请求仅传递的是hash, 并不真实上传文件数据, 所以对网络和服务器影响很小, 加上旧文件上传情况相对较少, 所以整体可以忽略不计</li></ol><h3 id="前后端如何协调"><a href="#前后端如何协调" class="headerlink" title="前后端如何协调"></a>前后端如何协调</h3><p>文件上传涉及到前后端的交互, 需要建立一个标准的通信协议, 通过协议要能完成下面几件核心交互:</p><ul><li>创建文件</li><li>hash校验</li><li>分片数据上传</li><li>分片合并</li></ul><h4 id="创建文件协议"><a href="#创建文件协议" class="headerlink" title="创建文件协议"></a>创建文件协议</h4><p>当客户端发送分片到服务器,需要告知服务器分片属于那一次文件上传,因此需要一个唯一标识来标识某一次文件上传</p><p>创建文件协议就是用于获取文件上传的唯一标识</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/11.png"></p><ul><li>uploadToken: 文件上传的唯一标识</li><li>chunkSize: 分片大小, 单位字节</li></ul><h4 id="hash校验协议"><a href="#hash校验协议" class="headerlink" title="hash校验协议"></a>hash校验协议</h4><p>客户端有时需要校验单个分片或整个文件的hash, 服务器需要告知客户端它们目的的具体情况</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/12.png"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/13.png"></p><ul><li>Upload-Hash-Type: 取值chunk或file, 分别代表分片hash和文件整体hash</li><li>Upload-Hash: 分片或文件的具体hash值</li><li>hasFile: 指示服务器是否已经存储了对应的分片或文件</li><li>rest: 当校验文件hash时持有的响应字段, 指示该文件还剩余那些hash没有上传</li><li>url: 当校验文件hash时持有响应字段, 如果该文件已经完成上传出现字段, 表示文件而请求地址</li></ul><h4 id="分片数据上传协议"><a href="#分片数据上传协议" class="headerlink" title="分片数据上传协议"></a>分片数据上传协议</h4><p>通过此协议. 上传具体的文件分片数据<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/14.png"></p><h4 id="分片合并协议"><a href="#分片合并协议" class="headerlink" title="分片合并协议"></a>分片合并协议</h4><p>当所有的分片全部上传后, 通过此协议请求服务器完成分片合并</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/15.png"></p><h3 id="代码如何组织"><a href="#代码如何组织" class="headerlink" title="代码如何组织"></a>代码如何组织</h3><p>大文件上传SDK的搭建分为三层</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/16.png"></p><ul><li>上传协议: 约定前后端的通信格式</li><li>upload-core: 基于协议的API, 提供协议字段的创建, 读取, 前后端通用工具函数等核心功能</li><li>upload-client: 应用于客户端的SDK</li><li>upload-server: 用于BFF的SDK</li></ul><h4 id="upload-core中的通用函数"><a href="#upload-core中的通用函数" class="headerlink" title="upload-core中的通用函数"></a>upload-core中的通用函数</h4><p><strong>EventEmitter</strong></p><p>统一前后端涉及到的基于各种事件的处理, 使用<strong>发布订阅模式</strong>提供统一的EventEmitter类</p><blockquote><p>前端可能出现的各种事件: 上传进度改变事件, 上传暂停&#x2F;恢复事件等等<br>后端可能出现的各种事件: 分片写入完成事件, 分布合并完成事件等等</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">EventEmitter</span>&lt;T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">events</span>: <span class="title class_">Map</span>&lt;T, <span class="title class_">Set</span>&lt;<span class="title class_">Function</span>&gt;&gt;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">on</span>(<span class="params">event: T, listener: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">has</span>(event)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">set</span>(event, <span class="keyword">new</span> <span class="title class_">Set</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(event)?.<span class="title function_">add</span>(listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">off</span>(<span class="params">event: T, listener: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">has</span>(event)) <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(event)?.<span class="title function_">delete</span>(listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">once</span>(<span class="params">event: T, listener: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onceListener</span> = (<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">listener</span>(...args)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(event, listener)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">on</span>(event, listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">event: T, ...args: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">has</span>(event)) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>.<span class="title function_">get</span>(event)?.<span class="title function_">forEach</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">listener</span>(...args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>TaskQueue</strong></p><p>为了支撑前后端的多任务并发执行, 提供TaskQueue类</p><blockquote><p>前端可能的并发执行: 并发请求<br>后端可能的并发执行: 并发的分片Hash校验</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可并发执行的任务队列</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TaskQueue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span>&lt;<span class="string">&#x27;start&#x27;</span> | <span class="string">&#x27;pause&#x27;</span> | <span class="string">&#x27;drain&#x27;</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 待执行的任务</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">tasks</span>: <span class="title class_">Set</span>&lt;<span class="title class_">Task</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="comment">// 当前正在执行的任务数</span></span><br><span class="line">  <span class="keyword">private</span> currentCount = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 任务状态</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">status</span>: <span class="string">&#x27;paused&#x27;</span> | <span class="string">&#x27;running&#x27;</span> = <span class="string">&#x27;paused&#x27;</span></span><br><span class="line">  <span class="comment">// 最大并发数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">concurency</span>: <span class="built_in">number</span> = <span class="number">4</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">concurency</span> = <span class="variable language_">this</span>.<span class="property">concurency</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加任务</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">...tasks: Task[]</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> t <span class="keyword">of</span> tasks) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">add</span>(t)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加任务并执行启动</span></span><br><span class="line">  <span class="title function_">addAndStart</span>(<span class="params">...tasks: Task[]</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">add</span>(...tasks)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">start</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 启动任务</span></span><br><span class="line">  <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="string">&#x27;running&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="property">size</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 当前无任务 触发drain事件</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;drain&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置任务状态为running</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;running&#x27;</span></span><br><span class="line">    <span class="comment">// 触发start事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">    <span class="comment">// 开始执行下一个任务</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">runNext</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">takeHeadTask</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> task = <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">values</span>().<span class="title function_">next</span>().<span class="property">value</span></span><br><span class="line">    <span class="keyword">if</span> (task) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">delete</span>(task)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> task</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行下一个任务</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">runNext</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> !== <span class="string">&#x27;running&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果整体的任务状态不是running 结束</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentCount</span> &gt;= <span class="variable language_">this</span>.<span class="property">concurency</span>) &#123;</span><br><span class="line">      <span class="comment">// 并发已满 结束</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取出第一个任务</span></span><br><span class="line">    <span class="keyword">const</span> task = <span class="variable language_">this</span>.<span class="title function_">takeHeadTask</span>()</span><br><span class="line">    <span class="keyword">if</span> (!task) &#123;</span><br><span class="line">      <span class="comment">// 没有任务了</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;paused&#x27;</span> <span class="comment">// 暂停执行</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;drain&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentCount</span>++</span><br><span class="line">    <span class="comment">// 执行任务</span></span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(task.<span class="title function_">run</span>()).<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 任务执行完成后, 当前任务数执行下一个任务</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentCount</span>--</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">runNext</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 暂停</span></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&#x27;paused&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;pause&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="前端-upload-client-代码中的复杂问题"><a href="#前端-upload-client-代码中的复杂问题" class="headerlink" title="前端(upload-client)代码中的复杂问题"></a>前端(upload-client)代码中的复杂问题</h4><p>前端涉及到两个核心问题:</p><ul><li>如何对文件分片</li><li>如何控制请求</li></ul><h5 id="如何对文件分片"><a href="#如何对文件分片" class="headerlink" title="如何对文件分片"></a>如何对文件分片</h5><p>首先要实现分片对象的处理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// chunk.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Chunk</span> &#123;</span><br><span class="line">  <span class="attr">blob</span>: <span class="title class_">Blob</span> <span class="comment">// 分片的二进制数据</span></span><br><span class="line">  <span class="attr">start</span>: <span class="built_in">number</span> <span class="comment">// 分片的起始位置</span></span><br><span class="line">  <span class="attr">end</span>: <span class="built_in">number</span> <span class="comment">// 分片的结束位置</span></span><br><span class="line">  <span class="attr">hash</span>: <span class="built_in">string</span> <span class="comment">// 分片的hash值</span></span><br><span class="line">  <span class="attr">index</span>: <span class="built_in">number</span> <span class="comment">// 分片在文件的索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个不带hash的chunk</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createChunk</span>(<span class="params"></span></span><br><span class="line"><span class="params">  file: File,</span></span><br><span class="line"><span class="params">  index: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  chunkSize: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Chunk</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> start = index * chunkSize</span><br><span class="line">  <span class="keyword">const</span> end = <span class="title class_">Math</span>.<span class="title function_">min</span>((index + <span class="number">1</span>) * chunkSize, file.<span class="property">size</span>)</span><br><span class="line">  <span class="keyword">const</span> blob = file.<span class="title function_">slice</span>(start, end)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    blob,</span><br><span class="line">    start,</span><br><span class="line">    end,</span><br><span class="line">    <span class="attr">hash</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    index</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算chunk的hash值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">calcChunkHash</span>(<span class="params">chunk: Chunk</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>.<span class="title class_">ArrayBuffer</span>()</span><br><span class="line">    <span class="keyword">const</span> fileReader = <span class="keyword">new</span> <span class="title class_">FileReader</span>()</span><br><span class="line">    fileReader.<span class="property">onload</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      spark.<span class="title function_">append</span>(e.<span class="property">target</span>?.<span class="property">result</span> <span class="keyword">as</span> <span class="title class_">ArrayBuffer</span>)</span><br><span class="line">      <span class="title function_">resolve</span>(spark.<span class="title function_">end</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    fileReader.<span class="title function_">readAsArrayBuffer</span>(chunk.<span class="property">blob</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来, 要对整个文件进行分片, 分片的方式有很多, 如:</p><ul><li>普通分片</li><li>基于多线程的分片</li><li>基于主线程时间切片的分片 (React Fiber)</li><li>其他分片模式</li></ul><p>考虑到通用性, 必须要向上层提供不同的分片模式, 同时还要允许上层自定义分片模式, 因此在设计上, 使用基于抽象类的<strong>模板模式</strong>来完成处理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ChunkSplitorEvents</span> = <span class="string">&#x27;chunks&#x27;</span> | <span class="string">&#x27;wholeHash&#x27;</span> | <span class="string">&#x27;drain&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ChunkSplitor</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span>&lt;<span class="title class_">ChunkSplitorEvents</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">chunkSize</span>: <span class="built_in">number</span> <span class="comment">// 分片大小 (单位字节)</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">file</span>: <span class="title class_">File</span> <span class="comment">// 待分片的文件</span></span><br><span class="line">  <span class="keyword">protected</span> hash?: <span class="built_in">string</span> <span class="comment">// 整个文件的hash</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">chunks</span>: <span class="title class_">Chunk</span>[] <span class="comment">// 分片列表</span></span><br><span class="line">  <span class="keyword">private</span> handleChunkCount = <span class="number">0</span> <span class="comment">// 已计算hash的分片数据</span></span><br><span class="line">  <span class="keyword">private</span> spark = <span class="keyword">new</span> <span class="title class_">SparkMD5</span>() <span class="comment">// 计算Hash的工具</span></span><br><span class="line">  <span class="keyword">private</span> hasSplited = <span class="literal">false</span> <span class="comment">// 是否已经分片</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">file: File, chunkSize: <span class="built_in">number</span> = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">file</span> = file</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chunkSize</span> = chunkSize</span><br><span class="line">    <span class="comment">// 获取分片数组</span></span><br><span class="line">    <span class="keyword">const</span> chunkCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="variable language_">this</span>.<span class="property">file</span>.<span class="property">size</span> / <span class="variable language_">this</span>.<span class="property">chunkSize</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chunks</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(chunkCount)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">_, index</span>) =&gt;</span> <span class="title function_">createChunk</span>(<span class="variable language_">this</span>.<span class="property">file</span>, index, <span class="variable language_">this</span>.<span class="property">chunkSize</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">split</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hasSplited</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hasSplited</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> emitter = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;<span class="string">&#x27;chunks&#x27;</span>&gt;()</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">chunkHanlder</span> = (<span class="params">chunks: Chunk[]</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chunks&#x27;</span>, chunks)</span><br><span class="line">      chunks.<span class="title function_">forEach</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">spark</span>.<span class="title function_">append</span>(chunk.<span class="property">hash</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handleChunkCount</span> += chunks.<span class="property">length</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handleChunkCount</span> === <span class="variable language_">this</span>.<span class="property">chunks</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="comment">// 计算完成</span></span><br><span class="line">        emitter.<span class="title function_">off</span>(<span class="string">&#x27;chunks&#x27;</span>, chunkHanlder)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;wholeHash&#x27;</span>, <span class="variable language_">this</span>.<span class="property">spark</span>.<span class="title function_">end</span>())</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">spark</span>.<span class="title function_">destroy</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;drain&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    emitter.<span class="title function_">on</span>(<span class="string">&#x27;chunks&#x27;</span>, chunkHanlder)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">calcHash</span>(<span class="variable language_">this</span>.<span class="property">chunks</span>, emitter)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">calcHash</span>(<span class="attr">chunks</span>: <span class="title class_">Chunk</span>[], <span class="attr">emitter</span>: <span class="title class_">EventEmitter</span>&lt;<span class="string">&#x27;chunks&#x27;</span>&gt;): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 分片完成后一些需要销毁的工作</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">dispose</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于此抽象类, 即可实现多种形式的分片模式, 每种模式只需要继承<code>ChunkSplitor</code>, 实现计算分片的hash即可</p><p>比如: 基于多线程的分片类可以非常简单的实现:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MutilThreadSplitor.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MutilThreadSplitor</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ChunkSplitor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">workers</span>: <span class="title class_">Worker</span>[] = <span class="keyword">new</span> <span class="title class_">Array</span>(navigator.<span class="property">hardwareConcurrency</span> || <span class="number">4</span>)</span><br><span class="line">    .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">    .<span class="title function_">map</span>(</span><br><span class="line">      <span class="function">() =&gt;</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&#x27;./SplitWorker.ts&#x27;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>), &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;module&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    )</span><br><span class="line">  <span class="title function_">calcHash</span>(<span class="attr">chunks</span>: <span class="title class_">Chunk</span>[], <span class="attr">emitter</span>: <span class="title class_">EventEmitter</span>&lt;<span class="string">&#x27;chunks&#x27;</span>&gt;): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> workerSize = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(chunks.<span class="property">length</span> / <span class="variable language_">this</span>.<span class="property">workers</span>.<span class="property">length</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">workers</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> worker = <span class="variable language_">this</span>.<span class="property">workers</span>[i]</span><br><span class="line">      <span class="keyword">const</span> start = i * workerSize</span><br><span class="line">      <span class="keyword">const</span> end = <span class="title class_">Math</span>.<span class="title function_">min</span>((i + <span class="number">1</span>) * workerSize, chunks.<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">const</span> workerChunks = chunks.<span class="title function_">slice</span>(start, end)</span><br><span class="line">      worker.<span class="title function_">postMessage</span>(workerChunks)</span><br><span class="line">      worker.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        emitter.<span class="title function_">emit</span>(<span class="string">&#x27;chunks&#x27;</span>, e.<span class="property">data</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">dispose</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">workers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">worker</span>) =&gt;</span> worker.<span class="title function_">terminate</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SplitWorker.ts</span></span><br><span class="line">onmessage = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> chunks = e.<span class="property">data</span> <span class="keyword">as</span> <span class="title class_">Chunk</span>[]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> chunk <span class="keyword">of</span> chunks) &#123;</span><br><span class="line">    <span class="title function_">calcChunkHash</span>(chunk).<span class="title function_">then</span>(<span class="function">(<span class="params">hash</span>) =&gt;</span> &#123;</span><br><span class="line">      chunk.<span class="property">hash</span> = hash</span><br><span class="line">      <span class="title function_">postMessage</span>([chunk])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="如何控制请求"><a href="#如何控制请求" class="headerlink" title="如何控制请求"></a>如何控制请求</h5><p>对请求的控制涉及多个方面的问题:</p><ol><li><strong>如何充分利用带宽</strong><br>分片上传中涉及到大量的请求发送, 这些请求即不能一起发送造成网络阻塞, 也不能依次发送浪费带宽资源, 因此需要有请求并发控制的机制<br>**方案: ** 利用基础库的TaskQueue实现并发控制</li><li>如何与上层请求库解耦<br>考虑到通用性, 上层应用可能会使用各种请求库发送请求, 因此前端SDK不能绑定任何的请求库<br><strong>方案:</strong> 使用<strong>策略模式</strong>对请求库解耦</li></ol><p>比如 请求策略</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求策略</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">RequestStrategy</span> &#123;</span><br><span class="line">    <span class="comment">// 文件创建请求, 返回token</span></span><br><span class="line">    <span class="title function_">createFile</span>(<span class="attr">file</span>: <span class="title class_">File</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">    <span class="comment">// 分片上传请求</span></span><br><span class="line">    <span class="title function_">uploadChunk</span>(<span class="attr">chunk</span>: <span class="title class_">Chunk</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;</span><br><span class="line">    <span class="comment">// 文件合并请求, 返回文件url</span></span><br><span class="line">    <span class="title function_">mergeFile</span>(<span class="attr">token</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">    <span class="comment">// hash校验请求</span></span><br><span class="line">    patchHash&lt;T <span class="keyword">extends</span> <span class="string">&#x27;file&#x27;</span> | <span class="string">&#x27;chunk&#x27;</span>&gt; (</span><br><span class="line">   		<span class="attr">token</span>: <span class="built_in">string</span>,</span><br><span class="line">        <span class="attr">hash</span>: <span class="built_in">string</span>,</span><br><span class="line">        <span class="attr">type</span>: T</span><br><span class="line">    ): <span class="title class_">Promise</span>&lt;</span><br><span class="line">        T <span class="keyword">extends</span> <span class="string">&#x27;file&#x27;</span> </span><br><span class="line">        ? &#123;<span class="attr">hasFile</span>: <span class="built_in">boolean</span>&#125; </span><br><span class="line">        : &#123;<span class="attr">hasFile</span>: <span class="built_in">boolean</span>; <span class="attr">rest</span>: <span class="built_in">number</span>[]; <span class="attr">url</span>: <span class="built_in">string</span>&#125;</span><br><span class="line">  &gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求控制</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">requestStrategy</span>: <span class="title class_">RequestStrategy</span>; <span class="comment">// 请求策略，没有传递则使用默认策略</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">splitStrategy</span>: <span class="title class_">ChunkSplitor</span>; <span class="comment">// 分片策略，没有传递则默认多线程分片</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">taskQueue</span>: <span class="title class_">TaskQueue</span>; <span class="comment">// 任务队列</span></span><br><span class="line">  <span class="comment">// 其他属性略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取文件token</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">token</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">createFile</span>(<span class="variable language_">this</span>.<span class="property">file</span>);</span><br><span class="line">    <span class="comment">// 分片事件监听</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">splitStrategy</span>.<span class="title function_">on</span>(<span class="string">&#x27;chunks&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleChunks</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">splitStrategy</span>.<span class="title function_">on</span>(<span class="string">&#x27;wholeHash&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleWholeHash</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分片事件处理</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">handleChunks</span>(<span class="params">chunks: Chunk[]</span>) &#123;</span><br><span class="line">    <span class="comment">// 分片上传任务加入队列</span></span><br><span class="line">    chunks.<span class="title function_">forEach</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">taskQueue</span>.<span class="title function_">addAndStart</span>(<span class="keyword">new</span> <span class="title class_">Task</span>(<span class="variable language_">this</span>.<span class="property">uploadChunk</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>), chunk));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadChunk</span>(<span class="params">chunk: Chunk</span>) &#123;</span><br><span class="line">    <span class="comment">// hash校验</span></span><br><span class="line">    <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">patchHash</span>(<span class="variable language_">this</span>.<span class="property">token</span>, chunk.<span class="property">hash</span>, <span class="string">&#x27;chunk&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (resp.<span class="property">hasFile</span>) &#123;</span><br><span class="line">      <span class="comment">// 文件已存在</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分片上传</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">uploadChunk</span>(chunk, <span class="variable language_">this</span>.<span class="property">uploadEmitter</span>);</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 整体hash事件处理</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">handleWholeHash</span>(<span class="params">hash: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="comment">// hash校验</span></span><br><span class="line">    <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">requestStrategy</span>.<span class="title function_">patchHash</span>(<span class="variable language_">this</span>.<span class="property">token</span>, hash, <span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (resp.<span class="property">hasFile</span>) &#123;</span><br><span class="line">      <span class="comment">// 文件已存在</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;end&#x27;</span>, resp.<span class="property">url</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据resp.rest重新编排后续任务</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="后端代码中的复杂问题"><a href="#后端代码中的复杂问题" class="headerlink" title="后端代码中的复杂问题"></a>后端代码中的复杂问题</h4><p>相对于客户端而言, 服务器面临着更大的挑战</p><h5 id="如何隔离不同的文件上传"><a href="#如何隔离不同的文件上传" class="headerlink" title="如何隔离不同的文件上传?"></a>如何隔离不同的文件上传?</h5><p>在创建文件协议中, 服务器使用uuid + jwt生成一个不可纂改的唯一编码, 用于标识不同的文件上传</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/17.png"></p><h5 id="如何保证分片不重复"><a href="#如何保证分片不重复" class="headerlink" title="如何保证分片不重复?"></a>如何保证分片不重复?</h5><p>重复的含义是指:</p><ol><li>不保存重复分片</li><li>不上传重复分片</li></ol><p>这就要求分片<strong>跨文件唯一</strong>, 并且<strong>永不删除</strong></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/18.png"></p><p>也就是: <strong>服务器并不保存合并之后的文件, 仅记录文件中的分片顺序</strong></p><h5 id="合并分片到底做什么"><a href="#合并分片到底做什么" class="headerlink" title="合并分片到底做什么?"></a>合并分片到底做什么?</h5><p>合并会造成很多问题, 比如:</p><ol><li>极其耗时(需要找到文件并组装)</li><li>数据冗余</li></ol><p>所以服务器并不发生真正的合并, 而是在数据库中记录文件中包含的分片</p><p>因此,合并操作时, 服务器仅做简单的处理:</p><ol><li>校验文件大小</li><li>校验文件hash</li><li>标记文件状态</li><li>生成文件访问地址</li><li>…</li></ol><p>上面操作效率很高</p><h5 id="实际访问文件"><a href="#实际访问文件" class="headerlink" title="实际访问文件"></a>实际访问文件</h5><p>由于服务器并未发生真正的文件合并, 当后续请求该文件时, 服务器需要动态处理, 具体的做法是:</p><ol><li>服务器收到对文件的请求, 并在数据库中找到了对应的文件</li><li>服务器读取文件的所有分片ID, 依次找到对应的分片文件</li><li>服务器利用TaskQueue的并发控制能力, 逐步产生文件读取流, 并利用管道直接输出到网络I&#x2F;O</li></ol><p>通用库的开发:</p><ul><li>从0到1开发整个upload-sdk, 该SDK为所有文件上传特别是<strong>大文件上传</strong>的场景提供前后端的支撑, 统一了所有文件上传的开发方式, 完成了从<strong>底层协议</strong>, <strong>工具类</strong>, <strong>前端组件</strong>, 后端中间件的开发</li><li>在实现层面,保证使用的灵活性, 利用多种设计模式完成了SDK和上层应用的完全解耦, 对服务器的存储结构进行了精细的设计, 保证了文件存储和传输的唯一性</li></ul><h3 id="总结如何实现Upload-SDK库"><a href="#总结如何实现Upload-SDK库" class="headerlink" title="总结如何实现Upload-SDK库"></a>总结如何实现Upload-SDK库</h3><blockquote><p>方案选择</p></blockquote><p>大文件上传的普遍性方案是文件分片, 文件分片其实就是ba整体的文件上传的大事务分成一个一个分片上传的小事务,从而降低失败的风险</p><p>整个大文件上传的实现会涉及到很多的技术细节</p><p>比如底层协议标准如何制定，协议标准决定了前后端如何交互，也就决定了前后端代码如何开发。</p><p>除了协议之外，还涉及到前端如何进行并发控制，如何高效的分片，以及涉及到后端如何存储分片，如何高效合并分片，如何保证分片的唯一性等等等等。</p><p>市面上没有形成统一的解决方案，虽然公有云上的OSS有各自的实现方案，但考虑到我们的产品可能会部署到客户的私有云上，所以最稳妥的办法还是自行实现整个大文件上传。</p><blockquote><p>技术实现</p></blockquote><p><strong>首先设计的是整体上传流程</strong></p><p>传统的大文件都是在客户端先完成所有的分片, 然后计算每个分片和完整的文件hash, 在使用hash和服务器换取当前文件的信息</p><p>由于hash的计算是CPU密集型的操作, 这样一来会导致长时间的客户端阻塞, 虽然可以使用web Worker来加速hash的计算, 但经过测试，即便是使用了多线程，某些超大文件比如上了10个G的文件，在配置不太好的客户机上计算时长可以超过30秒，这是无法接受的。</p><p>因此, 对上传流程进行了优化, 假定大部分文件上传都是一个新文件上传, 于是在流程上,允许用户在获得文件完整hash之前直接上传分片, 这样几乎可以做到零延时的上传, 等到文件整体hash计算来后, 在向服务器补充hash数据</p><p><strong>基于这样的流程，于是设计了一套标准化的文件上传协议</strong></p><p>协议主要包含四个通信标准:</p><ol><li>创建文件协议: 前端使用HEAD请求向服务器提交文件基本信息, 换取上传唯一token, 后续的请求必须携带此token</li><li>hash校验协议: 前端把某个分片hash或者是整个文件hash发送给服务器, 得到分片和文件的状态信息</li><li>分片上传协议: 前端将分片的二进制数据发送到服务器存储</li><li>分片合并协议: 前端提示服务器可以完成分片合并了</li></ol><p><strong>设计好协议后，接下来就需要落实到代码的实现上</strong></p><p>在前端部分主要问题集中在与: 如何分片 和 如何控制请求流程</p><p>首先是如何分片, 考虑到不同的场景可能选择不同的分片模式，比如多线程分片，比如基于时间切片（类似于React Fiber）的分片，甚至是由上层应用自行定义的分片模式。</p><p>于是在实现分片逻辑时，我使用了模版模式，利用TS的抽象类定义好分片的整体流程，具体的子类仅需实现分片hash计算即可，这样一来就可以保持极高的灵活度。</p><p>在请求流程控制层面，由于有诸多请求需要发送，因此我开发了一套并发请求控制类以充分的利用网络带宽。</p><p>另外，由于请求过程中需要向上层抛出各种钩子，比如进度的变化，请求状态的变化等等，对这一块，我使用了发布订阅模式编写了通用的EventEmitter类，这样可以在请求过程中抛出各种事件，上层应用通过监听事件完成处理。</p><p><strong>当然整个系统复杂度最高的还是在后端</strong></p><p>由于这个项目有BFF层，需要在BFF层完成文件处理，因此还需要针对服务器编写相应代码。</p><p>服务器最大的挑战就是如何保证每个分片的唯一性，这种唯一性即包含存储的唯一性，也包含传输的唯一性。</p><p>存储的唯一性保证了分片不会重复保存，避免了数据的冗余。</p><p>传输的唯一性保证了分片不会重复上传，避免了通信的冗余。</p><p>要保证分片不会重复保存，就必须让分片和文件解耦，分片是分片，文件是文件，分片独立保存，不从属于任何文件，文件独立记录，按照顺序依次指向不同分片，这样一来，哪怕出现两个不同文件拥有相同分片的场景，也不会在服务器出现重复存储的问题，因为分片是独立于文件的。</p><p>而要保证分片不会重复上传，就必须保证分片永不删除，如果在合并文件后删除了分片，就会导致下一次有相同分片上传时服务器找不到对应的分片文件，就必须重复上传，因此分片永不删除。</p><p>最后就是合并分片的逻辑，我考虑到如果真正的把分片文件合并成一个大文件，大文件的所有数据实际上都是冗余的，而且整个合并过程极其耗时，因此我做了这样的处理。</p><p>当收到合并请求时，服务器其实仅仅做一些简单的校验即可，比如文件大小、分片数量等校验，而不进行真正的合并，仅在数据库mongodb中更新该文件的状态并生成文件访问的url地址即可。</p><p>等到用户真正访问文件时，我根据数据库中对应文件的分片记录，使用文件流依次读取分片数据，用流管道直接响应给客户端即可。</p><p>这样一来整个合并效率和文件访问效率都极高，同时服务器的存储不会有任何冗余。</p><h1 id="ABT在前端基建中的实践"><a href="#ABT在前端基建中的实践" class="headerlink" title="ABT在前端基建中的实践"></a>ABT在前端基建中的实践</h1><h2 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h2><p>产品有时无法确定哪种设计方案更好，因此希望前端能够同时上线多个产品方案，根据某套规则将用户导流到不同的方案。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/19.png"></p><p>在用户体验理论研究中，这种做法称之为A&#x2F;B Testing（后续简称ABT）。</p><p>一次ABT实验会生成至少两套方案（对照组&#x2F;实验组），并且可以允许多个实验共存。</p><p>ABT实验会涉及多个岗位的协调，包含：前端、后端、测试、运维、产品，其中起主要作用的是产品和前端。</p><h2 id="问题和方案-1"><a href="#问题和方案-1" class="headerlink" title="问题和方案"></a>问题和方案</h2><p>ABT为前端带来诸多的挑战，其中包括：</p><h3 id="如何协作？"><a href="#如何协作？" class="headerlink" title="如何协作？"></a>如何协作？</h3><p>在一个实验生命周期内涉及到哪些角色，角色之间是如何协作的？</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/20.png"></p><h3 id="前端如何开发？"><a href="#前端如何开发？" class="headerlink" title="前端如何开发？"></a>前端如何开发？</h3><p>实验具有以下几个特点：</p><ol><li>多个实验共存<br>产品可能会先后发起几十个甚至上百个实验，不同的实验有不同的分流规则，每个实验又有多个对照组</li><li>实验是精确到组件的，一个实验对应到多个前端组件<br>一个组件不同的对照组之间的差异是灵活的</li><li>实验是频繁的</li><li>用户参与实验必须是无感的</li><li>实验推全后只保留一个对照组</li></ol><h4 id="流程和结构"><a href="#流程和结构" class="headerlink" title="流程和结构"></a>流程和结构</h4><p>ABT运作流程</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/21.png"></p><p>ABT SDK的结构</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/22.png" alt="image-20240306191832940"></p><p>整个ABT-SDK包含了诸多API和工具，为应用开发提供支撑，其中</p><ul><li>ABTCore： 提供ABT最底层的核心功能，比如实验信息、分流控制、代码剪枝、数据决策等等</li><li>ABT-Server： 针对服务器提供一些中间件</li><li>ABT-Vue&#x2F;ABT-React： 针对前端两种框架提供一些组件、仓库、路由等</li><li>ABT-Webpack&#x2F;ABT-Vite： 针对前端两种常见构建工具，提供一些插件集成，比如ESLint工具、PostCSS插件、命令行工具等等</li></ul><h4 id="如何分流？"><a href="#如何分流？" class="headerlink" title="如何分流？"></a>如何分流？</h4><ol><li>使用Redis存储当前每个实验不同对照组的参与人数</li><li>使用浏览器指纹+用户身份保证同一用户对同一实验仅参与一个组<br>两种做法<ul><li>将指纹+用户身份+组打包成JWT发送给客户端（不精准，成本低）</li><li>使用数据库保存映射关系（精准，成本高）</li></ul></li><li>按照规则中的分流比例为新用户分配组别</li><li>将所有实验的ID，以及每个组别的编号下发到客户端</li></ol><h4 id="如何改变运行代码？"><a href="#如何改变运行代码？" class="headerlink" title="如何改变运行代码？"></a>如何改变运行代码？</h4><p>实验和组别对运行时的影响主要是渲染组件的不同，但也有可能对其他代码造成影响。</p><p>由于每次实验所产生的差异是极其灵活的，因此难以使用一种标准化的静态格式来描述差异，这就不可避免的造成了对业务代码的侵入。</p><p>基建的一个重要目标就是要将这种侵入最小化、标准化。</p><p><strong>提供高阶组件屏蔽组件差异</strong></p><p>vue示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ABTesting name=&quot;exp1&quot;&gt;</span><br><span class="line">	&lt;template #default&gt;</span><br><span class="line">		&lt;DefaultComp&gt;&lt;/DefaultComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupB&gt;</span><br><span class="line">  	&lt;GroupBComp&gt;&lt;/GroupBComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupC&gt; </span><br><span class="line">  	&lt;GroupCComp&gt;&lt;/GroupCComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">&lt;/ABTesting&gt;</span><br></pre></td></tr></table></figure><p>react示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ABTesting </span><br><span class="line">  name=&quot;exp1&quot;</span><br><span class="line">  groupB=&#123;&lt;GroupBComp&gt;&lt;/GroupBComp&gt;&#125;</span><br><span class="line">  groupC=&#123;&lt;GroupCComp&gt;&lt;/GroupCComp&gt;&#125;</span><br><span class="line">  &gt;</span><br><span class="line">	&lt;DefaultComp&gt;&lt;/DefaultComp&gt;</span><br><span class="line">&lt;/ABTesting&gt;</span><br></pre></td></tr></table></figure><p><strong>提供高阶函数屏蔽API差异</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> utilMethod = <span class="title class_">ABTCore</span>.<span class="title function_">choose</span>(<span class="string">&#x27;exp1&#x27;</span>, defaultMethod, groupBMethod, groupCMethod)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">ABTCore</span>.<span class="title function_">call</span>(<span class="string">&#x27;exp1&#x27;</span>, defaultMethod, groupBMethod, groupCMethod);</span><br></pre></td></tr></table></figure><p><strong>使用自定义指令屏蔽CSS差异</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* style.css */</span></span><br><span class="line"><span class="keyword">@ab-testing</span> exp1 &#123;</span><br><span class="line">  default &#123;</span><br><span class="line">    <span class="comment">/* default styles */</span></span><br><span class="line">    <span class="selector-class">.a</span>&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  groupB &#123;</span><br><span class="line">    <span class="comment">/* groupB styles */</span></span><br><span class="line">    <span class="selector-class">.a</span>&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用自定义的PostCSS插件，会将上面的代码转换为</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exp1-default-<span class="selector-tag">a</span>&#123;&#125;</span><br><span class="line">exp1-groupb-<span class="selector-tag">a</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>与此同时，我们也改变了CSS Modules。</p><p>默认情况下，开启CSS Modules后，上面的代码会被转换为下面的JS</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="string">&quot;exp1-default-a&quot;</span>: <span class="string">&quot;hash1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;exp1-groupB-a&quot;</span>:<span class="string">&quot;hash2&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们对此作了改变，将代码变成了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; chooseValue &#125; <span class="keyword">from</span> <span class="string">&quot;ABTCore&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">chooseValue</span>(<span class="string">&quot;exp1&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">default</span>: &#123;</span><br><span class="line">      <span class="attr">a</span>: <span class="string">&quot;hash1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">groupB</span>: &#123;</span><br><span class="line">      <span class="attr">a</span>: <span class="string">&quot;hash2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h4 id="实验推全后如何处理？"><a href="#实验推全后如何处理？" class="headerlink" title="实验推全后如何处理？"></a>实验推全后如何处理？</h4><p>当产品完成实验后，会选定一种方案进行推全。</p><p>此时，会涉及到对应实验的代码如何剪枝的问题？</p><p>由于实验SDK并不向外界暴露当前用户所处的实验分组，因此，业务开发者要根据不同分组进行不同处理的代码逻辑必须使用实验SDK才能完成。</p><p>这就对自动化的实验推全提供了基础，由于所有的实验代码都是使用SDK完成的，因此可以通过一个简洁的逻辑即可完成自动化实验推全：</p><ol><li>实验SDK为各种构建工具提供插件</li><li>打包时，插件会通过代码分析（AST），找出当前哪些文件对应到哪些实验</li><li>插件会对照最新的实验信息，找到已经被推全的实验</li><li>插件定位到所有与该实验有关的源码文件</li><li>插件提示开发者，是否对已推全的实验进行剪枝</li><li>开发者确认后，插件自动修改AST完成剪枝</li></ol><p>通过AST完成剪枝逻辑是非常容易的</p><p>比如针对组件的剪枝</p><p>剪枝前</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ABTesting name=&quot;exp1&quot;&gt;</span><br><span class="line">	&lt;template #default&gt;</span><br><span class="line">		&lt;DefaultComp&gt;&lt;/DefaultComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupB&gt;</span><br><span class="line">  	&lt;GroupBComp&gt;&lt;/GroupBComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template #groupC&gt; </span><br><span class="line">  	&lt;GroupCComp&gt;&lt;/GroupCComp&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">&lt;/ABTesting&gt;</span><br></pre></td></tr></table></figure><p>剪枝后（假设将groupB推全）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;GroupBComp&gt;&lt;/GroupBComp&gt;</span><br></pre></td></tr></table></figure><h4 id="细节问题？"><a href="#细节问题？" class="headerlink" title="细节问题？"></a>细节问题？</h4><p><strong>白屏问题</strong></p><p>对于一个CSR应用，它的组件渲染取决于所处的组别，而它所属哪个组别又必须通过网络通信才能确定。</p><p>这就导致了首屏渲染的白屏问题。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/23.png"></p><p>而我们观察到整个应用中实际上只有部分组件会参与到实验，对于没有参与到实验的组件是不需要等待分组信息的。</p><p>因此，我们将参与到实验的组件制作为异步组件，从而可以不影响其他组件的渲染。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/24.png" alt="image-20240306194033162"></p><p><strong>代码检查问题</strong></p><p>由于实验推全时需要对代码进行剪枝，剪枝发生在编译时态，它通过AST检查代码中包含的ABT-SDK代码完成，而大部分ABT-SDK中的API都需要绑定实验名称，例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ABTCore</span>.<span class="title function_">call</span>(<span class="string">&#x27;exp1&#x27;</span>, defaultMethod, groupBMethod, groupCMethod);</span><br></pre></td></tr></table></figure><p>如果实验名称来自于一个变量或表达式或者其他需要在运行时才能确定的值，这就会导致剪枝失败。</p><p>因此我们制作了ESLint插件来约束开发者必须使用字面量或者其他在编译时态能确定的值。</p><p><strong>开发规范</strong></p><p>ABT-SDK不会暴露用户的分组信息给开发者，这主要是考虑到开发者可能写出下面的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(用户的分组 === <span class="string">&#x27;B&#x27;</span>)&#123;</span><br><span class="line">  <span class="comment">// 代码1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(用户的分组 === <span class="string">&#x27;C&#x27;</span>)&#123;</span><br><span class="line">  <span class="comment">// 代码2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的代码无法被代码剪枝工具察觉，容易在实验推全后仍然保留在代码中，虽然功能性不受影响，但会逐步降低代码的可维护性。</p><p>以上是不暴露的主要原因。</p><p>但开发者仍然有可能间接的获取到用户的分组，比如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="title class_">ABTCore</span>.<span class="title function_">data</span>(<span class="string">&quot;exp1&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">groupB</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">  <span class="attr">groupC</span>: <span class="string">&quot;C&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span>(data === <span class="string">&#x27;B&#x27;</span>)&#123;</span><br><span class="line">  <span class="comment">// 代码1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(data === <span class="string">&#x27;C&#x27;</span>)&#123;</span><br><span class="line">  <span class="comment">// 代码2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种代码很难通过自动化工具检查处理，因此需要通过开发规范来约束：</p><p><em>所有跟实验相关的处理，必须通过ABT-SDK完成</em></p><p><strong>项目介绍</strong>：</p><ol><li>ABT-SDK是一套为AB实验提供技术支撑的开发工具包，它分为底层的ABT-Core，以及上层的ABT-Server、ABT-Vue、ABT-React、ABT-Webpack、ABT-Vite，可以集成到BFF、Vue&#x2F;React框架、Webpack&#x2F;Vite工程。</li><li>整个ABT-SDK的开发使用到了诸多前端技术，包括但不仅限于： 自定义PostCSS&#x2F;ESLint&#x2F;Webpack&#x2F;Vite插件、AST分析、浏览器指纹、Vue&#x2F;React高阶组件、脚手架开发…</li></ol><p><strong>项目职责</strong>：</p><ol><li>参与ABT工具链的开发和集成</li><li>参与ABT规范和协作流程的制定</li><li>参与ABT和前端框架的集成</li><li>其他技术难点攻坚</li></ol><p><strong>项目亮点</strong>：</p><p>从0到1开发整个A&#x2F;B Testing SDK，为产品制定AB实验提供技术支撑，SDK可作用于Vue、React、Webpack、Vite、BFF等前端常见的技术场景，为AB实验开发提供全流程支撑。</p><p>整套SDK不仅中止了AB实验业务开发的混乱局面，为前端AB实验业务的开发提效70%，减少90%的代码出错几率，同时大幅提升代码质量。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>请介绍你开发的A&#x2F;B Testing SDK</strong></p><blockquote><p>背景</p></blockquote><p>这套SDK是为支撑AB实验研发的，属于是我们前端基建的一部分。</p>。<p>之所以要开发这套SDK，是因为在没有它之前，要走完一次AB实验的流程成本是非常高的，<strong>后来经过我的调研和分析</strong>，造成这种高成本的根本原因就是缺乏标准化。</p><p>具体来说体现在几个方面：</p><ol><li>没有标准化的流程 –&gt; 管理成本<br>举例： 实验冲突问题</li><li>没有标准化的工具 –&gt; 维护成本<br>举例： 实验推全时代码剪枝问题</li><li>没有标准化的API –&gt; 开发成本<br>举例： AB实验全面侵入业务代码，心智负担过重</li></ol><blockquote><p>方案选择</p></blockquote><p>所以，解决方案是非常明确的，就是标准化。</p><p>但如何标准化，目前前端领域没有一个统一且成熟的答案，之所以没有，是因为AB实验是深度绑定业务的，而业务的差异化导致难以在技术领域形成标准。</p><p>可以把每次实验的每个组别都当作是产品提出的一次业务需求，这种需求是极其灵活的，因此难以形成技术领域的标准。</p><p>虽然难以形成技术领域的标准，但形成公司内部的标准却是可行的。</p><p>当然这种标准是多方面的，我这里单从技术的角度聊一聊API的标准化。</p><p>API标准化的重要目标就是要把前端代码当中所有跟AB实验相关的代码从语义的角度进行隔离。</p><p>举例1： 逻辑判断</p><p>举例2： 高阶组件</p><p>这种隔离不仅可以提升开发效率，而且对将来的实验推全奠定了自动化的基础。</p><p>当然，API只是整套SDK的一部分，因为我们的前端代码是散落在不同技术位置的，比如node服务器搭建的BFF、以jQuery为主的活动页面、Webpack搭建的多页应用、Vite搭建的组件库等等等等。</p><p>要适配多种技术场景，我们把SDK分为了底层和上层，底层提供核心API，上层调用底层的API产生多个库，适配不同的技术场景。（见简历）</p><p>总之，整套SDK就是保证无论是哪种技术场景，都能够在其中找到合适的工具。</p><p>比如自动化的实验推全，SDK中有相应的命令行工具，也可以使用它的webpack插件或者vite插件在打包时自动推全。</p><p>比如实验分流，SDK中有相应的工具，会根据用户身份和浏览器指纹以及分流规则、实验状态等信息共同决定用户应该处于哪个实验分组。</p><p>再比如对于CSS代码，SDK中有相应的PostCSS插件，可以识别我们自定义的CSS指令，这些指令是我们单独为AB实验定制的，因此需要开发自定义的插件来解析。</p><blockquote><p>最终效果</p></blockquote><p>总之，有了这套SDK后，有过统计，在AB实验的开发效率上提升了70%，并且减少了90%的代码出错几率，同时在代码可读性可维护性上都有大幅度提升。</p><h1 id="首屏优化"><a href="#首屏优化" class="headerlink" title="首屏优化"></a>首屏优化</h1><h2 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h2><p>公司的产品面向的是企业用户，大部分企业用户会选择对产品进行私有化部署。</p><p>企业对产品的需求是差异化的，因此公司研发了一套低码平台方便客户对产品进行差异化定制。</p><p>客户通过低码平台的定制会产生JS文件，这些JS文件会在运行时加载。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/25.svg" alt="差异化部署" style="zoom:50%"><p>大量客户反馈首屏等待时间过长的问题，需要制定针对性的优化策略解决问题。</p><p>而要针对性的优化必须要先弄清楚目前的性能热点在哪里，因此，我们将整个优化过程分为三步：</p><ol><li>问题的收集与分析</li><li>措施的制定与实施</li><li>方案的部署与反馈</li></ol><p>以上三步可反复轮询，直到问题解决。</p><h2 id="问题的收集与分析"><a href="#问题的收集与分析" class="headerlink" title="问题的收集与分析"></a>问题的收集与分析</h2><p>这一步的目标是要准确的找到客户侧的问题究竟在哪，找不到问题就无法针对性的制定优化措施。</p><p>而要找到问题并不容易，根据过往经验，大系统的优化问题定位往往需要几个环节的反复进行。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/26.svg" alt="问题收集和分析" style="zoom:50%"><p>可是问题发生在客户侧，而客户侧的系统不直接暴露到公网，因此收集问题的环节就非常麻烦。</p><p>因此，我们搭建了一套客户侧数据上报的流程，让客户可以安全的把性能数据推送到我们的数据中心。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/27.svg" alt="数据上报" style="zoom:50%"><p>制定这套流程的初衷，不仅是为了方便收集目前特定用户的性能问题，更重要的是可以收集任何客户反馈的任何问题。</p><p>要落实这一系列流程，需要在技术面提供多方面的支持：</p><ol><li>服务监控系统的更改（前端、后端）</li><li>数据脱敏（大数据）</li><li>数据展示（前端）</li><li>问题实验室（前端、BFF）</li></ol><p>最终，经过几轮测试，问题被清晰的定位：</p><ul><li>HTTP1.1协议效率低下的问题<ul><li>队头阻塞</li><li>头部臃肿</li></ul></li><li>大量的JS代码重复</li><li>大量JS代码无差别加载</li><li>大量的API网络请求</li></ul><h2 id="措施的制定与实施"><a href="#措施的制定与实施" class="headerlink" title="措施的制定与实施"></a>措施的制定与实施</h2><h3 id="针对HTTP1-1的优化措施"><a href="#针对HTTP1-1的优化措施" class="headerlink" title="针对HTTP1.1的优化措施"></a>针对HTTP1.1的优化措施</h3><p><strong>队头阻塞问题</strong></p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/28.png" alt="image-20211027133404730" style="zoom:30%" align="left"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://mdrs.yuanjin.tech/img/20211026175005.png" alt="image-20211026175005607" style="zoom:30%" align="left"><p>针对这一问题，没有别的办法，只能多开域名来解决。</p><blockquote><p>浏览器针对同一域名可以支持最多6个TCP并发连接，超越这个数字后将发生队头阻塞</p></blockquote><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/29.svg" alt="解决队头阻塞" style="zoom:50%"><p><strong>头部臃肿</strong></p><p>由于HTTP1.1不支持头部压缩，而发送的请求中包含大量的自定义头部，于是我们借鉴了HTTP2的头部压缩方式，对自定义头部进行了压缩处理。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/31.png" alt="image-20211027132744018image-20211027132744018"></p><h3 id="针对重复代码的优化措施"><a href="#针对重复代码的优化措施" class="headerlink" title="针对重复代码的优化措施"></a>针对重复代码的优化措施</h3><p>客户侧会产生巨量的差异化JS文件，每个JS文件的产生逻辑非常简单：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/32.svg" alt="差异化JS的产生" style="zoom:50%"><p>结果就是客户侧保存了大量JS代码文件，并且代码文件中出现了大量重复代码。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// g-d8a65e.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">formItems</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 其他差异配置,</span></span><br><span class="line">      <span class="title function_">init</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 代码段a</span></span><br><span class="line">        <span class="comment">// 其他差异代码段</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">focus</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 代码段a</span></span><br><span class="line">        <span class="comment">// 其他差异代码段</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// g-e218fa.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">formItems</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 其他差异配置,</span></span><br><span class="line">      <span class="title function_">validate</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 代码段a</span></span><br><span class="line">        <span class="comment">// 其他差异代码段</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">blur</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 代码段a</span></span><br><span class="line">        <span class="comment">// 其他差异代码段</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比较容易想到的解决办法，是把那些有可能出现差异的代码提取到公共代码中。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/33.svg" alt="解决重复代码-方案1" style="zoom:50%"><p>这种方案除了逻辑简单，根本无法实施，主要原因是：</p><ol><li>很难知道客户侧会产生哪些重复代码</li><li>如果把所有可能都枚举到公共代码中，会产生大量的无效代码</li></ol><p>因此，对重复代码的提取必须动态完成。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/34.svg" alt="解决重复代码-方案2" style="zoom:50%"><p>这里面有两个关键问题：</p><ol><li>如何找到代码中的重复？</li><li>何时提重？</li></ol><h4 id="如何找到重复？"><a href="#如何找到重复？" class="headerlink" title="如何找到重复？"></a>如何找到重复？</h4><p>考虑下面两段代码，如何找到重复？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码片段1</span></span><br><span class="line"><span class="keyword">const</span> selectSource = <span class="string">&quot;department&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> source = <span class="title function_">getData</span>(selectSource);</span><br><span class="line"><span class="title function_">bindSelectSource</span>(&#123;</span><br><span class="line">  source,</span><br><span class="line">  <span class="attr">label</span>: <span class="function">(<span class="params">s</span>)=&gt;</span><span class="string">`<span class="subst">$&#123;s.name&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">value</span>: <span class="function">(<span class="params">s</span>)=&gt;</span><span class="string">`<span class="subst">$&#123;s.id&#125;</span>`</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 代码片段2</span></span><br><span class="line"><span class="keyword">const</span> selectSource = <span class="string">&quot;task&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> source = <span class="title function_">getData</span>(selectSource);</span><br><span class="line"><span class="title function_">bindSelectSource</span>(&#123;</span><br><span class="line">  source,</span><br><span class="line">  <span class="attr">label</span>: <span class="function">(<span class="params">s</span>)=&gt;</span><span class="string">`<span class="subst">$&#123;s.title&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">value</span>: <span class="function">(<span class="params">s</span>)=&gt;</span><span class="string">`<span class="subst">$&#123;s.id&#125;</span>`</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>通过AST分析，可以得到两棵树</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/post_img/FrontProject/35.png" alt="对比"></p><p>我们的目标是：找出两棵树<strong>连续</strong>的<strong>相同结构</strong>的节点，将它们提取成函数，同时把相同结构中的不同点提取为函数参数。</p><p>大致思路是：</p><ol><li>计算每个节点的结构hash</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量声明节点的hash求值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VariableDeclarationNode</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略其他代码</span></span><br><span class="line">  </span><br><span class="line">  <span class="title function_">hash</span>(<span class="params"></span>)&#123;</span><br><span class="line">  	md5.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">kind</span>); <span class="comment">// const、var、let</span></span><br><span class="line">    md5.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">name</span>); <span class="comment">// 变量名</span></span><br><span class="line">    md5.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">init</span>.<span class="property">type</span>); <span class="comment">// 初始值类型： 字面量、表达式、变量</span></span><br><span class="line">    <span class="keyword">return</span> md5.<span class="title function_">end</span>(); <span class="comment">// 得到hash</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>将AST树信息入库（含hash结果）</li></ol><p>库中的信息大致如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;struct&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        hash<span class="punctuation">:</span> <span class="string">&quot;.....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        hash<span class="punctuation">:</span> <span class="string">&quot;.....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;struct&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        hash<span class="punctuation">:</span> <span class="string">&quot;.....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        hash<span class="punctuation">:</span> <span class="string">&quot;.....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span> hash<span class="punctuation">:</span> <span class="string">&quot;....&quot;</span><span class="punctuation">,</span> children<span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><ol start="3"><li>寻找库中出现的连续的、hash一致的节点进行提重。</li><li>将差异点提取为参数</li></ol><p>最终提重的结果如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repeating.js</span></span><br><span class="line"><span class="comment">// 自动提重后的代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rp_2d4ef</span>(<span class="params">p1, p2</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> selectSource = p1;</span><br><span class="line">  <span class="keyword">const</span> source = <span class="title function_">getData</span>(selectSource);</span><br><span class="line">  <span class="title function_">bindSelectSource</span>(&#123;</span><br><span class="line">    source,</span><br><span class="line">    <span class="attr">label</span>: <span class="function">(<span class="params">s</span>)=&gt;</span><span class="string">`<span class="subst">$&#123;s[p2]&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">value</span>: <span class="function">(<span class="params">s</span>)=&gt;</span><span class="string">`<span class="subst">$&#123;s.id&#125;</span>`</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后代码片段被修改为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码片段1</span></span><br><span class="line"><span class="title function_">rp_2d4ef</span>(<span class="string">&quot;department&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// 代码片段2</span></span><br><span class="line"><span class="title function_">rp_2d4ef</span>(<span class="string">&quot;task&quot;</span>, <span class="string">&quot;title&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="何时提重？"><a href="#何时提重？" class="headerlink" title="何时提重？"></a>何时提重？</h4><p>为了保证效率，提重可以异步延时执行，也可以开启计划任务在服务器空闲时执行，也可以管理员手动执行。</p><h3 id="针对无差别加载的优化措施"><a href="#针对无差别加载的优化措施" class="headerlink" title="针对无差别加载的优化措施"></a>针对无差别加载的优化措施</h3><p>过去，用户侧自定义产生的差异JS都是在首屏全部加载的，实际上，很多JS并不需要在当前页面运行。</p><p>因此，需要对这些JS进行差别化加载，视口内需要的先加载，不需要的延迟加载。</p><p>这就需要做到两件事：</p><ol><li>定义每个功能页视口内组件</li><li>标识每个JS文件对应到哪个组件（已有功能）</li></ol><p>此时很容易完成，不再详细阐述。</p><h3 id="针对大量API网络请求的优化措施"><a href="#针对大量API网络请求的优化措施" class="headerlink" title="针对大量API网络请求的优化措施"></a>针对大量API网络请求的优化措施</h3><p>大量的首屏请求均来自自动化生成的差异代码，其中包含大量的GET重复请求。</p><p>我们针对性的加入了短时缓存，让相同的请求走缓存通道。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动生成的代码</span></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getSelectSource</span>(<span class="string">&#x27;department&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改为</span></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">withCache</span>(getSelectSource, <span class="string">&#x27;department&#x27;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">withCache</span>(<span class="params">fn, ...args</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span>(!map)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fn</span>(...args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> caches = map.<span class="title function_">get</span>(fn);</span><br><span class="line">  <span class="keyword">if</span>(!caches)&#123;</span><br><span class="line">    <span class="comment">// 无缓存，初始化</span></span><br><span class="line">    map.<span class="title function_">set</span>(fn, caches = []);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> cache = caches.<span class="title function_">find</span>(<span class="function"><span class="params">c</span>=&gt;</span><span class="title function_">isSameArgs</span>(args, c.<span class="property">args</span>)); <span class="comment">// 按参数查找缓存</span></span><br><span class="line">  <span class="keyword">if</span>(!cache)&#123;</span><br><span class="line">    <span class="comment">// 无缓存，初始化</span></span><br><span class="line">    caches.<span class="title function_">push</span>(cache = &#123;</span><br><span class="line">      args,</span><br><span class="line">      <span class="attr">value</span>: <span class="title function_">fn</span>(...args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CACHE_DURATION</span> = <span class="number">5000</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  map = <span class="literal">null</span>;</span><br><span class="line">&#125;, <span class="variable constant_">CACHE_DURATION</span>)</span><br></pre></td></tr></table></figure><p><strong>项目亮点</strong>：</p><p>针对客户反馈的首屏慢问题制定了详细的优化策略并完整参与了优化措施的落地。</p><p>通过数据埋点收集和定位性能问题，通过本地实验室复现问题。针对问题制定了具体的优化措施，包括解决了HTTP1.1的队头阻塞和头部无压缩的问题，以及开发了自动化工具完成自动代码提重从而压缩包体积等诸多手段。</p><p>经过优化后的代码LCP时间降低了80%，同时提供了一套完整标准的工单流程。</p><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p><strong>请讲讲你是如何首屏优化的</strong></p><blockquote><p>策略的制定</p></blockquote><p>无论是做哪一种优化，都需要经过三个步骤：定位问题、解决问题、测试反馈。</p><p>很多时候都是在这三个步骤间反复轮询。</p><p>而我们项目的难点在于我们的产品很多是私有化部署，并且用户可以通过低码平台实现产品的高度定制。也就是说我们无法知晓客户定制了哪些内容，由定制产生了多少JS文件，无法复现客户的运行环境，无法复现客户的问题。</p><p>所以我首先是制定了一套完整的工单申报流程，为每个客户提出的问题发起工单，然后在本地开启工单的代码分支，在分支里面针对性的加入埋点代码，然后推送代码给用户。</p><p>用户一端收集的信息经过数据脱敏后上报到我们的数据中心，我这边根据数据最终定位问题。</p><p>下面我挑一两个问题说吧。</p><blockquote><p>技术实现</p></blockquote><p>我们当时遇到的一个比较大的问题是HTTP1.1的效率问题，因为我们的客户有些浏览器是不支持HTTP2的，而首屏加载的资源量数量非常多，受我们架构的影响又很难合并它们，所以会遇到HTTP1.1的队头阻塞和头部压缩的问题。</p><p>针对队头阻塞，我使用了多域名的方式解决，这是常规手段，没多少可说的。而头部压缩这一块，我是借鉴了HTTP2的做法，在客户端和服务器分别建立静态表和动态表，把所有的自定义头部压缩成了一个，压缩比最高可以达到90，这是非常惊人的。</p><p>另外除了网络这一块，还遇到一个比较棘手的问题就是重复代码。客户那边很多代码是他们通过低码平台自动生成的，有些定制度比较高的客户可能生成了好几百个JS，这些JS文件中存在大量重复的代码，从而增加了整体的传输体积。</p><p>所以我开发了一套任务，它可以自动嗅探到多个JS文件中的重复代码，并把他们提取到一个公共JS中形成一个一个的函数，把差异化的地方自动提取为参数，然后自动修改原始JS文件的相应位置，把它们变成一个一个的函数调用。</p><p>这件事说起来简单，实际开发起来其实是非常复杂的，它涉及到抽象语法树分析、树结构对比从而发现重复和提取重复、hash运算和数据库存储等一系列的事情，因为这件事是在BFF层完成的，所以也是由我们前端处理的。</p><p>其他的优化还有很多，有些简单有些麻烦，但最棘手、我印象最深的就是上面两点。</p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">月晕</div><div class="post-copyright__author_desc">生命是有光的</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.yueyun.site/posts/72a725a9.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://blog.yueyun.site/posts/72a725a9.html")'>前端项目中的亮点</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.yueyun.site/posts/72a725a9.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.yueyun.site" target="_blank">月晕</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E5%89%8D%E7%AB%AF/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span>前端<span class="categoryesPageCount">7</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/JavaScript/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>JavaScript<span class="tagsPageCount">10</span></a><a class="post-meta__box__tags" href="/tags/React/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>React<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>前端<span class="tagsPageCount">8</span></a><a class="post-meta__box__tags" href="/tags/TypeScript/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TypeScript<span class="tagsPageCount">2</span></a></div></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/34b82b37.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1702557863466.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">记录上班的感想</div></div></a></div><div class="next-post pull-right"><a href="/posts/b7adae81.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1705040055654.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">算法例题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/938f2f9c.html" title="React Native开坑"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1702557508740.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-15</div><div class="title">React Native开坑</div></div></a></div><div><a href="/posts/49ae955a.html" title="React 源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/wallpaper/2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-15</div><div class="title">React 源码分析</div></div></a></div><div><a href="/posts/9ac48510.html" title="React学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1701613946910.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-12</div><div class="title">React学习</div></div></a></div><div><a href="/posts/d681bdaf.html" title="TypeScript语言学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/liang.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-22</div><div class="title">TypeScript语言学习</div></div></a></div><div><a href="/posts/317b894e.html" title="Vue学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1702396713207.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-12</div><div class="title">Vue学习</div></div></a></div><div><a href="/posts/ea5e4ee3.html" title="Vue部分源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1700908595951.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-25</div><div class="title">Vue部分源码分析</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display:none">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__decoration"><img class="avatar-decoration-1" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d1.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"><img class="avatar-decoration-2" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d2.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"><img class="avatar-decoration-3" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d3.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"><img class="avatar-decoration-4" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/avatar_desc/avatar_d4.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="decoration"></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">月晕</h1><div class="author-info__desc">生命是有光的</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=3514392356&amp;website=www.oicqzone.com" target="_blank" title="QQ"><i class="anzhiyufont anzhiyu-icon-qq"></i></a><a class="social-icon faa-parent animated-hover" href="https://github.com/apprehen" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/554370301" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E5%B0%81%E8%A3%85%E5%92%8C%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">网络库的封装和实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%92%8C%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">方案和设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E7%BB%93%E6%9E%84%E7%9A%84%E5%AE%8F%E8%A7%82%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.1.</span> <span class="toc-text">库结构的宏观设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">请求缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%BB%93%E6%9E%9C%E6%80%8E%E4%B9%88%E5%AD%98-%E5%AD%98%E5%9C%A8%E9%82%A3%E4%BA%9B%E5%9C%B0%E6%96%B9-%E7%BC%93%E5%AD%98%E9%94%AE%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">请求结果怎么存? 存在那些地方? 缓存键是什么?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%BD%95%E6%97%B6%E5%A4%B1%E6%95%88-%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E8%BF%98%E6%98%AF%E5%85%B6%E4%BB%96%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">缓存何时失效? 基于时间还是其他条件?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">如何实现?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%B9%82%E7%AD%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">请求幂等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.4.</span> <span class="toc-text">样本代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%AF%B7%E6%B1%82%E5%BA%93"><span class="toc-number">1.3.</span> <span class="toc-text">总结如何实现请求库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.</span> <span class="toc-text">大文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-1"><span class="toc-number">2.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%92%8C%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.</span> <span class="toc-text">问题和方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E9%A1%B5%E9%9D%A2%E9%98%BB%E5%A1%9E"><span class="toc-number">2.2.1.</span> <span class="toc-text">如何减少页面阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%A6%82%E4%BD%95%E5%8D%8F%E8%B0%83"><span class="toc-number">2.2.2.</span> <span class="toc-text">前后端如何协调</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">创建文件协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash%E6%A0%A1%E9%AA%8C%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">hash校验协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">分片数据上传协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%90%88%E5%B9%B6%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">分片合并协议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%A6%82%E4%BD%95%E7%BB%84%E7%BB%87"><span class="toc-number">2.2.3.</span> <span class="toc-text">代码如何组织</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#upload-core%E4%B8%AD%E7%9A%84%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">upload-core中的通用函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF-upload-client-%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%A4%8D%E6%9D%82%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">前端(upload-client)代码中的复杂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AF%B9%E6%96%87%E4%BB%B6%E5%88%86%E7%89%87"><span class="toc-number">2.2.3.2.1.</span> <span class="toc-text">如何对文件分片</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">2.2.3.2.2.</span> <span class="toc-text">如何控制请求</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%A4%8D%E6%9D%82%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">后端代码中的复杂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%9A%94%E7%A6%BB%E4%B8%8D%E5%90%8C%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.2.3.3.1.</span> <span class="toc-text">如何隔离不同的文件上传?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%88%86%E7%89%87%E4%B8%8D%E9%87%8D%E5%A4%8D"><span class="toc-number">2.2.3.3.2.</span> <span class="toc-text">如何保证分片不重复?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E5%88%86%E7%89%87%E5%88%B0%E5%BA%95%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.3.3.3.</span> <span class="toc-text">合并分片到底做什么?</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E8%AE%BF%E9%97%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.3.3.4.</span> <span class="toc-text">实际访问文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0Upload-SDK%E5%BA%93"><span class="toc-number">2.2.4.</span> <span class="toc-text">总结如何实现Upload-SDK库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ABT%E5%9C%A8%E5%89%8D%E7%AB%AF%E5%9F%BA%E5%BB%BA%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.</span> <span class="toc-text">ABT在前端基建中的实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-2"><span class="toc-number">3.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%92%8C%E6%96%B9%E6%A1%88-1"><span class="toc-number">3.2.</span> <span class="toc-text">问题和方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8D%8F%E4%BD%9C%EF%BC%9F"><span class="toc-number">3.2.1.</span> <span class="toc-text">如何协作？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%EF%BC%9F"><span class="toc-number">3.2.2.</span> <span class="toc-text">前端如何开发？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%92%8C%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">流程和结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%86%E6%B5%81%EF%BC%9F"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">如何分流？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%94%B9%E5%8F%98%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%9F"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">如何改变运行代码？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8E%A8%E5%85%A8%E5%90%8E%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">实验推全后如何处理？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">细节问题？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.3.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A6%96%E5%B1%8F%E4%BC%98%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">首屏优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF-3"><span class="toc-number">4.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%9A%84%E6%94%B6%E9%9B%86%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">问题的收集与分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%AA%E6%96%BD%E7%9A%84%E5%88%B6%E5%AE%9A%E4%B8%8E%E5%AE%9E%E6%96%BD"><span class="toc-number">4.3.</span> <span class="toc-text">措施的制定与实施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9HTTP1-1%E7%9A%84%E4%BC%98%E5%8C%96%E6%8E%AA%E6%96%BD"><span class="toc-number">4.3.1.</span> <span class="toc-text">针对HTTP1.1的优化措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81%E7%9A%84%E4%BC%98%E5%8C%96%E6%8E%AA%E6%96%BD"><span class="toc-number">4.3.2.</span> <span class="toc-text">针对重复代码的优化措施</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E9%87%8D%E5%A4%8D%EF%BC%9F"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">如何找到重复？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E6%8F%90%E9%87%8D%EF%BC%9F"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">何时提重？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E6%97%A0%E5%B7%AE%E5%88%AB%E5%8A%A0%E8%BD%BD%E7%9A%84%E4%BC%98%E5%8C%96%E6%8E%AA%E6%96%BD"><span class="toc-number">4.3.3.</span> <span class="toc-text">针对无差别加载的优化措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E5%A4%A7%E9%87%8FAPI%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%9A%84%E4%BC%98%E5%8C%96%E6%8E%AA%E6%96%BD"><span class="toc-number">4.3.4.</span> <span class="toc-text">针对大量API网络请求的优化措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">4.3.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/b7adae81.html" title="算法例题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1705040055654.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="算法例题"></a><div class="content"><a class="title" href="/posts/b7adae81.html" title="算法例题">算法例题</a><time datetime="2024-06-24T11:07:49.339Z" title="发表于 2024-06-24 11:07:49">2024-06-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/72a725a9.html" title="前端项目中的亮点"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1719120534005.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="前端项目中的亮点"></a><div class="content"><a class="title" href="/posts/72a725a9.html" title="前端项目中的亮点">前端项目中的亮点</a><time datetime="2024-06-23T13:26:24.000Z" title="发表于 2024-06-23 13:26:24">2024-06-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/34b82b37.html" title="记录上班的感想"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/1702557863466.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="记录上班的感想"></a><div class="content"><a class="title" href="/posts/34b82b37.html" title="记录上班的感想">记录上班的感想</a><time datetime="2024-04-17T20:55:27.000Z" title="发表于 2024-04-17 20:55:27">2024-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ac8590ca.html" title="go 语言速成"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/postCover/5370198c46b7e6193aad423d755464fd5aa83820_raw.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="go 语言速成"></a><div class="content"><a class="title" href="/posts/ac8590ca.html" title="go 语言速成">go 语言速成</a><time datetime="2024-01-16T13:38:42.000Z" title="发表于 2024-01-16 13:38:42">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9c0aba3e.html" title="leetcode 刷题(每日一题) 记录"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1301952160.cos.ap-shanghai.myqcloud.com/Apprehensive/wallpaper/1703262863447.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="leetcode 刷题(每日一题) 记录"></a><div class="content"><a class="title" href="/posts/9c0aba3e.html" title="leetcode 刷题(每日一题) 记录">leetcode 刷题(每日一题) 记录</a><time datetime="2023-12-27T10:47:16.000Z" title="发表于 2023-12-27 10:47:16">2023-12-27</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/yueyun.jpg" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/apprehen" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div class="copyright">&copy;2023 - 2024 By 月晕</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">14</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>留言</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Clash/" style="font-size:.88rem">Clash<sup>1</sup></a><a href="/tags/Git/" style="font-size:.88rem">Git<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size:.88rem">JavaScript<sup>10</sup></a><a href="/tags/Linux/" style="font-size:.88rem">Linux<sup>2</sup></a><a href="/tags/NestJS/" style="font-size:.88rem">NestJS<sup>1</sup></a><a href="/tags/Nginx/" style="font-size:.88rem">Nginx<sup>1</sup></a><a href="/tags/PM2/" style="font-size:.88rem">PM2<sup>1</sup></a><a href="/tags/Python/" style="font-size:.88rem">Python<sup>1</sup></a><a href="/tags/React/" style="font-size:.88rem">React<sup>4</sup></a><a href="/tags/React-Native/" style="font-size:.88rem">React Native<sup>1</sup></a><a href="/tags/TypeScript/" style="font-size:.88rem">TypeScript<sup>2</sup></a><a href="/tags/Vite/" style="font-size:.88rem">Vite<sup>1</sup></a><a href="/tags/Vue/" style="font-size:.88rem">Vue<sup>2</sup></a><a href="/tags/go/" style="font-size:.88rem">go<sup>1</sup></a><a href="/tags/leetcode/" style="font-size:.88rem">leetcode<sup>1</sup></a><a href="/tags/life/" style="font-size:.88rem">life<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size:.88rem">代理<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size:.88rem;font-weight:500;color:var(--anzhiyu-lighttext)">前端<sup>8</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" style="font-size:.88rem">前端框架<sup>2</sup></a><a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size:.88rem">反向代理<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size:.88rem">后端<sup>2</sup></a><a href="/tags/%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7/" style="font-size:.88rem">打包工具<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:.88rem">数据结构<sup>2</sup></a><a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" style="font-size:.88rem">浏览器工作原理<sup>1</sup></a><a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size:.88rem">源码分析<sup>2</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size:.88rem">爬虫<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:.88rem">算法<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size:.88rem">计算机<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size:.88rem;font-weight:500;color:var(--anzhiyu-lighttext)">计算机基础<sup>3</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:.88rem">计算机操作系统<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">计算机网络<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size:.88rem">面试题<sup>1</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://chat.yueyun.site',
      region: 'ap-hangzhou',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.21/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://chat.yueyun.site',
      region: 'ap-hangzhou',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-W3DLGJMJDY', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginModelPath:"assets/",model:{jsonPath:"/live2dw/assets/unitychan.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>